var Wizard=function(v){function f(a){var c=$("#wizard-container").find("#wizard-"+a);c.length||console.error("Element not found: #wizard-"+a);return c}function B(a){a=a||{};var c=f("columns"),e=c.find(".wizard-column").length;c=f("column-template").clone().attr("id","wizard-column-"+e).appendTo(c).removeClass("invisible");c.find(".wizard-column-name").val(a.name);e=c.find(".wizard-column-type");a.data_type?(e.append("<option selected>"+a.data_type+"</option>"),e.val(a.data_type)):e.combobox();c.find(".wizard-column-nullable").prop("checked",
a.is_nullable);c.find(".wizard-column-pk").prop("checked",a.is_pk);c.find(".wizard-column-drop").bind("click",function(d){d.currentTarget.closest(".wizard-column").remove()});c.find(".wizard-column-pk").bind("change",function(d){d=$(d.currentTarget);d.prop("checked")&&d.closest(".wizard-column").find(".wizard-column-nullable").prop("checked",!1)});a.name&&f("csv-preview").find("thead tr").append("<th>"+a.name+"</th>")}function G(a){a=a||{};var c=f("csv-columns"),e=c.find(".wizard-csv-column").length;
c=f("csv-column-template").clone().attr("id","wizard-csv-column-"+e).appendTo(c).removeClass("invisible");c.find(".wizard-csv-column-name").val(a.name);c.find(".wizard-csv-column-name-new").val(a.nameDB).bind("change",x);c.find(".wizard-csv-column-parse").val("").bind("change",x)}function H(a,c,e){function d(k,l,n){l=Math.floor(Math.random()*(n-l))+l;n="";for(var w=0;w<l;w++)n+=k[Math.floor(Math.random()*k.length)];return n}var g=["???"];if(/.*int/.exec(a)||/.*serial/.exec(a))g=[10,342,0,-892,231,
51,2,5];else if(/(real|double|float)/.exec(a))g=[.1,-3.1,.015,.34,-.821678,234.3242];else if(/numeric[ ]*\(([0-9]+),[ ]*([0-9]+)\)/.exec(a)){var h=parseInt(/numeric[ ]*\(([0-9]+),[ ]*([0-9]+)\)/.exec(a)[2]);g=["-23.","273.","29.","-55.","."].map(function(k){return k+d("1234567890000000",h,h)})}else if(/timestamp/.exec(a))g=["2020-01-01 10:38:00","1970-10-11 12:00:00","1981-09-07 12:30:01"];else if(/time/.exec(a))g=["10:38:00","12:00:00","12:30:01"];else if(/date/.exec(a))g=["2020-01-01","1970-10-11",
"1981-09-07"];else if(/text/.exec(a))g=["lorem","ipsum","blablabla","hello world",'"quoted'+e+' text with delimiter"'];else if(/varchar[ ]*\(([0-9]+)\)/.exec(a))h=parseInt(/varchar[ ]*\(([0-9]+)\)/.exec(a)[1]),h=Math.min(h,16),g=["lorem","ipsum","blablabla","hello world"],g=g.map(function(k){return k.slice(0,Math.floor(Math.random()*h))});else{if(/char[ ]*\(([0-9]+)\)/.exec(a))return h=parseInt(/char[ ]*\(([0-9]+)\)/.exec(a)[1]),d("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",h,h);/bool/.exec(a)&&
(g=[!0,!1])}c%=g.length;return g[c]}function x(){for(var a={},c=0;c<b.columns.length;c++)a[b.columns[c].name]=c,b.columns[c].idxCsv=void 0,b.columns[c].parse=function(){return null};f("csv-columns").find(".wizard-csv-column").each(function(e,d){var g=$(d).find(".wizard-csv-column-name-new").val();d=$(d).find(".wizard-csv-column-parse").val();var h=y[d].parse,k=a[g];b.csvColumns[e].nameDB=g;b.csvColumns[e].idxDB=k;b.csvColumns[e].parse=h;void 0!==k&&(b.columns[k].idxCsv=e,b.columns[k].parseName=d,
b.columns[k].parse=function(){return function(l){l=l[e];var n=null;try{n=h(l)}catch(w){console.error(w)}return n}}())});b.rowMapper=function(e){return b.columns.map(function(d){d=d.parse(e);return""===d?null:d})};I()}function J(a){a=a||b.table;return"/api/"+b.apiVersion+"/schema/"+b.schema+"/tables/"+a}function p(a){return"/api/"+b.apiVersion+"/advanced/"+a}function K(a){a=a||b.table;return"/dataedit/upload/"+b.schema+"/"+a}function z(a){a.responseJSON&&a.responseJSON.reason?a=a.responseJSON.reason:
a.statusText&&(a=a.statusText);return a}function m(a,c,e,d,g){var h=L();console.log(a,c,e,e?JSON.parse(e):void 0);return $.ajax({url:c,headers:{"X-CSRFToken":h},data_type:"json",cache:!1,contentType:"application/json; charset=utf-8",processData:!1,data:e,type:a,converters:{"text json":function(k){return k}},success:d,error:g})}function L(){var a=null;if(document.cookie&&""!==document.cookie)for(var c=document.cookie.split(";"),e=0;e<c.length;e++){var d=$.trim(c[e]);if("csrftoken="===d.substring(0,
10)){a=decodeURIComponent(d.substring(10));break}}return a}function C(a){var c=parseFloat(a);if(isNaN(c))throw"Error parsing value to number: "+a;return c}function I(){var a=f("csv-preview").find("tbody");a.empty();b.previewRows.map(b.rowMapper).map(function(c){var e=$("<tr>").appendTo(a);c.map(function(d){null==d||void 0==d?$('<td class="wizard-td-null">').appendTo(e):$("<td>"+d+"</td>").appendTo(e)})})}function D(){b.file=f("file");b.encoding=f("encoding").find(":selected").val();b.delimiter=f("delimiter").find(":selected").val();
b.header=f("header").prop("checked");b.file&&b.file[0]&&b.file[0].files&&b.file[0].files[0]?(b.fileSizeBytes=b.file[0].files[0].size,b.fileName=b.file[0].files[0].name,f("file-label").text(b.fileName+" ("+b.fileSizeBytes+" bytes)")):(b.fileSizeBytes=null,b.fileName=null,b.file=null,f("file-label").text(""))}function M(a){a=a.toLowerCase();for(var c=0;c<b.columns.length;c++)if(b.columns[c].name.toLowerCase()==a)return b.columns[c].name}function N(){var a="";if(b.columns){var c=b.delimiter||",";b.header&&
(a+=b.columns.map(function(d){return d.name}).join(c)+"\n");for(var e=0;e<b.exampleRows;e++)a+=b.columns.map(function(d){return H(d.data_type,e,c)}).join(c)+"\n"}f("csv-example").text(a)}function r(){D();b.csvColumns=[];N();f("csv-columns").empty();f("csv-text").text("");b.file&&b.file.parse({config:{encoding:b.encoding,skipEmptyLines:b.skipEmptyLines,preview:b.previewSizeRecords+(b.header?1:0),delimiter:b.delimiter,newline:b.newline,complete:function(a,c){if(a.data.length){E(a.data);f("csv-text").text(a.data.map(function(d){return d.join(a.meta.delimiter)}).join("\n"));
c=a.data[0].length;if(b.header){for(var e=0;e<c;e++)b.csvColumns.push({name:a.data[0][e],nameDB:M(a.data[0][e])});b.previewRows=a.data.slice(1,b.previewSizeRecords+1)}else{for(e=0;e<c;e++)b.csvColumns.push({name:b.csvColumnPrefix+(e+1),nameDB:b.columns.length>e?b.columns[e].name:void 0});b.previewRows=a.data}for(e=0;e<c;e++)G(b.csvColumns[e])}x()},error:function(a){console.error(a)}}})}function t(a){var c='{"connection_id": '+b.connection_id;b.cursor_id&&(c=c+', "cursor_id": '+b.cursor_id);a&&(a=
{schema:b.schema,table:b.table,fields:b.columns?b.columns.map(function(e){return e.name}):void 0,values:a},c=c+', "query": '+JSON.stringify(a));return c+"}"}function E(a){a.map(function(c){c[c.length-1]=c[c.length-1].replace("\r","")})}function u(a){a=a||"upload failed";if(b.connection_id){var c=t();b.connection_id=null;m("POST",p("connection/rollback"),c).then(function(){return m("POST",p("connection/close"),c)}).then(function(){q("danger",!1,a);F()})}}function O(){q("danger",!0,"cancel upload...");
b.cancel=!0}function P(){D();b.file&&(b.csvParser=null,b.connection_id=null,b.cursor_id=null,b.uploadProgressBytes=0,b.skippedHeader=b.header?!1:!0,b.uploadedRows=0,b.cancel=!1,f("table-upload").hide(),f("table-upload-cancel").show(),q("primary",0,"starting upload..."),m("POST",p("connection/open")).then(function(a){b.connection_id=/"connection_id":[ ]*([0-9]+)/.exec(a)[1];return m("POST",p("cursor/open"),t())}).then(function(a){b.cursor_id=/"cursor_id":[ ]*([0-9]+)/.exec(a)[1];b.file.parse({config:{encoding:b.encoding,
skipEmptyLines:b.skipEmptyLines,preview:b.previewSizeRecords+(b.header?1:0),delimiter:b.delimiter,newline:b.newline,chunkSize:b.uploadChunkSize,chunk:function(c,e){b.cancel?u("cancel"):(b.uploadProgressBytes=c.meta.cursor,E(c.data),0<c.data.length&&!b.skippedHeader&&(b.skippedHeader=!0,c.data=c.data.slice(1)),0<c.data.length&&(b.csvParser=e,b.csvParser.pause(),c=c.data.map(b.rowMapper),m("POST",p("insert"),t(c)).then(function(d){b.cancel?u("cancel"):(d=JSON.parse(d).content.rowcount,b.uploadedRows+=
d,d=b.uploadProgressBytes/b.fileSizeBytes*100,d=Math.round(d||0),q("primary",d,d+"% rows: "+b.uploadedRows),b.csvParser.resume())}).catch(function(d){u(z(d))})))},complete:function(){b.cancel?u("cancel"):(q("primary",100,"finishing upload..."),m("POST",p("connection/commit"),t()).then(function(){return m("POST",p("connection/close"),t())}).then(function(){q("success",!1,"upload ok")}))},error:function(c){u(z(c))}}})}).catch(function(a){console.error("catch",a)}))}function Q(){A("primary",!0,"creating table...");
var a=[],c=[];f("columns").find(".wizard-column").each(function(h,k){h=$(k);h={name:h.find(".wizard-column-name").val(),data_type:h.find(".wizard-column-type").val(),is_nullable:h.find(".wizard-column-nullable").prop("checked"),is_pk:h.find(".wizard-column-pk").prop("checked")};a.push(h);h.is_pk&&c.push({constraint_type:"PRIMARY KEY",constraint_parameter:h.name})});var e=f("tablename").val(),d=J(e)+"/",g=K(e);m("PUT",d,JSON.stringify({query:{columns:a,constraints:c}})).then(function(){A("success",
!0,"ok, reloading page...");window.location=g}).catch(function(h){A("danger",!1,z(h))})}function F(){b.cancel=null;f("table-upload").show();f("table-upload-cancel").hide()}function A(a,c,e){var d=$("#wizard-table-create-msg");d.removeClass();d.addClass("alert alert-"+a);d.find(".message").text(e);c?d.find(".spinner").removeClass("invisible"):d.find(".spinner").addClass("invisible")}function q(a,c,e){var d=$("#wizard-table-upload-msg");d.removeClass();if(a){d.show();var g=d.find(".progress");d.addClass("alert alert-"+
a);d.find(".message").text(e);!0===c?(d.find(".spinner").show(),g.hide()):(d.find(".spinner").hide(),!1!==c?(g.show(),g.find(".progress-bar").css("width",c+"%")):g.hide())}else d.hide()}var b={schema:"model_draft",apiVersion:"v0",previewSizeRecords:10,exampleRows:5,csvColumnPrefix:"Column_",uploadChunkSize:10,newline:"\n",skipEmptyLines:"greedy",canAdd:v.canAdd,columns:v.columns,table:v.table,nRows:v.nRows,connection_id:null,cursor_id:null,previewRows:null,csvParser:null,csvColumns:null,rowMapper:null,
skippedHeader:null,uploadProgressBytes:null,fileSizeBytes:null,uploadedRows:null,fileName:null,cancel:null},y={parseFloat2:{parse:C,label:"Number (Englisch)"},parseFloatGerman:{parse:function(a){a=a.replace(",",".");return C(a)},label:"Number (German)"},"":{parse:function(a){return a},label:""}},R="boolean;smallint;integer;bigint;float;real;date;time;datetime;char(5);varchar(128);text;decimal(9, 6)".split(";");(function(){var a=f("csv-column-template .wizard-csv-column-parse");Object.keys(y).map(function(g){a.append('<option value="'+
g+'">'+y[g].label+"</option>")});f("column-add").bind("click",function(){B()});f("table-create").bind("click",Q);f("file").bind("change",r);f("encoding").bind("change",r);f("delimiter").bind("change",r);f("header").bind("change",r);f("table-upload").bind("click",P);f("table-upload-cancel").bind("click",O);var c=f("column-template .wizard-column-type");c.append("<option selected></option>");R.map(function(g){c.append("<option>"+g+"</option>")});r();F();if(b.table){f("tablename").val(b.table);for(var e=
0;e<b.columns.length;e++)B(b.columns[e]);var d=f("csv-column-template .wizard-csv-column-name-new");d.append("<option selected></option>");b.columns.map(function(g){d.append("<option>"+g.name+"</option>")});f("container-create").collapse("hide");f("container-upload").collapse("show");f("container-create").find(".btn").hide();f("container-create").find("input").prop("readonly",!0);f("container-create").find("input,select,.combobox-container").not("[type=text]").prop("disabled",!0);b.canAdd||(q("danger",
!1,"You have no permission to upload to this table"),f("container-upload").find(".btn").hide(),f("container-upload").find("input").prop("readonly",!0),f("container-upload").find("input,select,.combobox-container").not("[type=text]").prop("disabled",!0))}else f("container-upload").collapse("hide"),f("container-create").collapse("show"),f("container-upload").find(".btn").hide(),f("container-upload").find("input").prop("readonly",!0),f("container-upload").find("input,select,.combobox-container").not("[type=text]").prop("disabled",
!0)})();$("#wizard-loading").hide();return{state:b}};
