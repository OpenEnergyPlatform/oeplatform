<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Editor Sidebar Layout Demo</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- Autocomplete CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@trevoreyre/autocomplete-js/dist/style.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="sidebar-layout.css">
    <link rel="stylesheet" href="metaedit.css">
</head>
<body>
    <div class="d-flex justify-content-center">
        <div class="spinner-border text-primary m-5" role="status" id="metaedit-loading">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Fixed Controls -->
    <div class="fixed-controls d-none" id="metaedit-controls">
        <div class="btn-group" role="group">
            <button class="btn btn-success btn-sm" id="metaedit-submit">
                <span class="spinner-border text-light d-none spinner-border-sm" id="metaedit-submitting"></span>
                <i class="fa fa-save mr-1"></i>Submit
            </button>
            <button class="btn btn-secondary btn-sm" id="metaedit-cancel">
                <i class="fa fa-times mr-1"></i>Cancel
            </button>
            <button class="btn btn-primary btn-sm" id="metaedit-download">
                <i class="fa fa-download mr-1"></i>Download
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@2.9.1/dist/jsoneditor.min.js"></script>
    <script src="https://unpkg.com/@trevoreyre/autocomplete-js"></script>
    <script src="sidebar-metaedit.js"></script>

    <script>
        // Demo configuration
        var config = {
            standalone: true,
            table: 'demo_table',
            url_table_id: 'demo/demo_table',
            columns: [
                { name: 'id', data_type: 'integer' },
                { name: 'name', data_type: 'string' },
                { name: 'value', data_type: 'float' },
                { name: 'date', data_type: 'date' }
            ],
            url_api_meta: '/api/metadata/',
            url_view_table: '/view/table/',
            cancle_url: '/cancel/'
        };

        // Initialize the sidebar metadata editor
        $(document).ready(function() {
            // Load schema from local file for demo
            $.getJSON('schema.json').done(function(schema) {
                config.schema = schema;
                SidebarMetaEdit(config);
            }).fail(function() {
                console.error('Failed to load schema.json');
                alert('Failed to load schema file. Please ensure schema.json is available.');
            });
        });

        // Demo callbacks for JSON Editor
        window.JSONEditor = window.JSONEditor || {};
        window.JSONEditor.defaults = window.JSONEditor.defaults || {};
        window.JSONEditor.defaults.callbacks = {
            "autocomplete": {
                "search_name": function search(jseditor_editor, input) {
                    var url = "https://openenergyplatform.org/api/oeo-search?query=" + input;
                    
                    return new Promise(function(resolve) {
                        fetch(url, {
                            mode: 'cors',
                        }).then(function(response) {
                            return response.json();
                        }).then(function(data) {
                            resolve(data["docs"] || []);
                        }).catch(function() {
                            resolve([]);
                        });
                    });
                },
                "renderResult_name": function(jseditor_editor, result, props) {
                    return ['<li ' + props + '>',
                        '<div class="eiao-object-snippet">' + result.label + '<small>' + '<span style="color:green">' + ' : ' + result.definition + '</span></div>',
                        '</li>'].join('');
                },
                "getResultValue_name": function getResultValue(jseditor_editor, result) {
                    var selected_value = String(result.label).replaceAll("<B>", "").replaceAll("</B>", "");
                    
                    let path = String(jseditor_editor.path).replace("name", "@id");
                    let path_uri = config.editor.getEditor(path);
                    if (path_uri) {
                        path_uri.setValue(String(result.resource));
                    }
                    
                    return selected_value;
                },
            },
            "button": {
                "openModalAction": function openOeoExtPlugin(jseditor, e) {
                    console.log('Modal action triggered');
                    alert('Modal functionality would be implemented here');
                }
            }
        };
    </script>
</body>
</html>
