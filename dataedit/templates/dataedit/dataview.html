{% extends "dataedit/base.html" %}
{% load dataedit.metadata %}
{% load static %}
{% load bootstrap4 %}

{% block site-header %}
  {% if title %}
  <h2 class="site-header">{{ schema }}: {{ title }}</h2>
  {% else  %}
  <h3 class="site-header"><a href="/dataedit/view/{{ schema }}">{{ schema }}</a>.{{ table }}</h3>
  {% endif %}
{% endblock site-header %}
{% block data_content %}

  <ul class="nav nav-tabs">
    <li class="nav-item">
      <a class="nav-link {% if current_view.type == "table" %}active{% endif %}"
         href="/dataedit/view/{{ schema }}/{{ table }}">Table</a>
    </li>
    <li class="nav-item dropdown">
      <a class="nav-link dropdown-toggle {% if current_view.type == "graph" %}active{% endif %}" data-toggle="dropdown"
         href="#" role="button" aria-haspopup="true" aria-expanded="false">Graphs</a>
      <div class="dropdown-menu">
        {% for view in views %}
          {% if view.type == "graph" %}
            <a class="dropdown-item" href="?view={{ view.id }}">{{ view.name }}</a>
          {% endif %}
        {% endfor %}
        <div class="dropdown-divider"></div>
        <a class="dropdown-item" href="/dataedit/view/{{ schema }}/{{ table }}/graph/new">Add Graph View</a>
      </div>
    </li>
    <li class="nav-item dropdown">
      <a class="nav-link dropdown-toggle {% if current_view.type == "map" %}active{% endif %}" data-toggle="dropdown"
         href="#" role="button" aria-haspopup="true" aria-expanded="false">Maps</a>
      <div class="dropdown-menu">
        {% for view in views %}
          {% if view.type == "map" %}
            <a class="dropdown-item" href="?view={{ view.id }}">{{ view.name }}</a>
          {% endif %}
        {% endfor %}
        <div class="dropdown-divider"></div>
        <a class="dropdown-item" href="/dataedit/view/{{ schema }}/{{ table }}/map/geom/new">Add gis view</a>
        <a class="dropdown-item" href="/dataedit/view/{{ schema }}/{{ table }}/map/latlon/new">Add lat/lon view</a>
      </div>
    </li>
  </ul>

  <div>
    <div class="datatable">
      <table class="display" id="datatable" style="width:100%">
        <thead>
        <tr></tr>
        </thead>
      </table>

       <div class="panel-group">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title">
                <a data-toggle="collapse" href="#collapseBuilder">Filter dataset</a>
              </h4>
            </div>
            <div id="collapseBuilder" class="panel-collapse collapse">
              <div class="panel-body">
                <div id="builder" style="width: 100%"></div>
                <button id="btn-set" class="btn btn-success set-json" data-target="basic">Set rules</button>
                <button id="btn-download-view" class="btn btn-success set-json" data-target="basic">Download View</button>
              </div>
            </div>
          </div>
        </div>

      <div>

      </div>
      {% if current_view.type == "map" %}
        <div style='height: 800px; width: 100%;' id="map"></div>
      {% endif %}
      {% if current_view.type == "graph" %}
        <div id="datagraph"></div>
      {% endif %}
      <div id="loading-indicator" class="sk-fading-circle">
        <div class="sk-circle1 sk-circle"></div>
        <div class="sk-circle2 sk-circle"></div>
        <div class="sk-circle3 sk-circle"></div>
        <div class="sk-circle4 sk-circle"></div>
        <div class="sk-circle5 sk-circle"></div>
        <div class="sk-circle6 sk-circle"></div>
        <div class="sk-circle7 sk-circle"></div>
        <div class="sk-circle8 sk-circle"></div>
        <div class="sk-circle9 sk-circle"></div>
        <div class="sk-circle10 sk-circle"></div>
        <div class="sk-circle11 sk-circle"></div>
        <div class="sk-circle12 sk-circle"></div>
      </div>
    </div>
  </div>

  <div>
    <br>
    <br>
    <h4>
      Meta Information
    </h4>
    <button class="btn btn-sm btn-success" onclick="downloadMetadata();" data-toggle="tooltip" title="Download metadata in JSON format">Download JSON</button>
    <span class="mb-2" {% if not can_add %} data-toggle="tooltip" title="You need write permissions on this table to edit metadata" {% endif %}>
      <a href="{{table}}/meta_edit" type="button"  class="btn btn-success btn-sm {% if not can_add %} disabled {% endif %}">Edit</a>
    </span>

    {{ meta_widget }}
 </div>
 
 <div id = "comment_section" >
 {% if anonymous_user == 0 %}
	<form style="width:80%"  method="POST" action="/dataedit/view/{{ schema }}/{{ table }}">
	    {% csrf_token %}
	    {{comment_form.as_p}}
	      <button type="submit" class="btn btn-success" name="save" style="font-size: 10px; margin-right: 20px; margin-bottom: 50px">Comment</button>
	</form>
 {% endif %}

	{% for value in comments.all %}
		<div class="position-static" style="margin-bottom: 30px"> 
			<ul>
				<i class="fas fa-user" style="font-size: 20px; color:black" > </i> 

				<b class="text-sm-left" style="margin-left: 10px; font-size: 20px; color:rgb(80,90,150)"> {{ value.user }} </b>
				
				<span class="badge rounded-pill bg-light text-dark" style="margin-left: 40px; font-size: 12px"> <em>@{{ value.comment_time }} </em> </span>
			
				<div style="margin-left: 40px; display: block; clear:both; margin-top: 10px; margin-bottom:20px;"> {{ value.content }} </div>
			
			
				{% if anonymous_user == 0 %}
					<form style="width:80%"  method="POST" action="/dataedit/view/{{ schema }}/{{ table }}">
						{% csrf_token %}
					
						<input type="hidden"  name="CommentID" value = {{ value.id }}  >
						
						<button type="submit" class="btn btn-primary" name="Likes" style="font-size: 8px; margin-top:2px; margin-bottom:20px; margin-left: 45px" >
							<i class="far fa-thumbs-up" > <em>{{ value.liked_users.all | length }}</em></i>
						</button>

						<button type="submit" class="btn btn-dark" name="DisLikes" style="font-size: 8px;  margin-top:2px; margin-bottom:20px; margin-left: 10px" >
							<i class="far fa-thumbs-down" > <em>{{ value.disked_users.all | length }}</em></i>
						</button>
												
						{% if value.user.id == user.id %}
						<button type="submit" class="btn btn-danger" name="Delete" style="font-size: 8px;  margin-top:2px; margin-bottom:20px; margin-left: 10px" >
								<i class="fa fa-trash" ></i>
						</button>
						{% else %}
						<button type="submit" disabled class="btn btn-danger" name="Delete" style="font-size: 8px;  margin-top:2px; margin-bottom:20px; margin-left: 10px" >
								<i class="fa fa-trash" ></i>
						</button>
						{% endif %}
						
						<button type="button" class="btn btn-secondary " style="font-size: 8px;  margin-top:2px; margin-bottom:20px; margin-left: 10px" onclick="myFunction({{ value.id }})"><i class="fas fa-comment" ></i></button>
						
					</form>
				
					<div>
						<div id={{ value.id }} style="display:none">
							<form method="POST" action="/dataedit/view/{{ schema }}/{{ table }}">
								{% csrf_token %}
								<input type="hidden"  name="CommentID" value = {{ value.id }}  >
								<textarea id="summernote" placeholder='Replying to {{ value.user }}' name='content' style="width=100%; height=90px; padding: 2%; margin-left: 150px; position=absolute" required></textarea>
								<button type="submit" class="btn btn-sm btn-success" style="font-size: 7px"> Reply </button>
							</form>
						</div>
					</div>
				
				{% endif %}
				
				{% for child_comment in value.children %}
				<div style="margin-top:20px">
					<ul>
					
						<i class="fas fa-user" style="color:black" > </i> 

						<b class="text-sm-left" style="color:rgb(80,90,150); margin-left:10px "> {{ child_comment.user }} </b>
						
						<span class="badge rounded-pill bg-light text-dark" style="margin-left:15px; font-size: 12px"> <em>@{{ child_comment.comment_time }} </em> </span>
			
						<div style="display: block; clear:both; margin-top: 10px; margin-left:25px "> {{ child_comment.content }} </div>
						
						<form style="width:80%"  method="POST" action="/dataedit/view/{{ schema }}/{{ table }}">
						
						{% csrf_token %}
				
						{% if anonymous_user == 0 %}
							<input type="hidden"  name="CommentID" value = {{ child_comment.id }}  >
						
							<button type="submit" class="btn btn-primary" name="Likes" style="font-size: 8px; margin-top:20px; margin-bottom:20px; margin-left: 45px" >
								<i class="far fa-thumbs-up" > <em>{{ child_comment.liked_users.all | length }}</em></i>
							</button>

							<button type="submit" class="btn btn-dark" name="DisLikes" style="font-size: 8px;  margin-top:20px; margin-bottom:20px; margin-left: 10px"  >
								<i class="far fa-thumbs-down" > <em>{{ child_comment.disked_users.all | length }}</em></i>
							</button>
												
							{% if child_comment.user.id == user.id %}
							<button type="submit" class="btn btn-danger" name="Delete" style="font-size: 8px;  margin-top:20px; margin-bottom:20px; margin-left: 10px" >
								<i class="fa fa-trash" ></i>
							</button>
							{% else %}
							<button type="submit" disabled class="btn btn-danger" name="Delete" style="font-size: 8px;  margin-top:20px; margin-bottom:20px; margin-left: 10px" >
								<i class="fa fa-trash" ></i>
							</button>
							{% endif %}
							
							<button type="button" class="btn btn-secondary " style="font-size: 8px;  margin-top:20px; margin-bottom:20px; margin-left: 10px" onclick="myFunction({{ child_comment.id }})"><i class="fas fa-comment" ></i></button>
						{% endif %}

							<a class="btn btn-sm btn-success" href = "{% url 'comments_view' schema=schema table=table comment_id=child_comment.id %}" style="font-size: 10px;  margin-top:20px; margin-bottom:20px; margin-left: 10px"> <em>View More Replies</em> </a>
						
						{% if anonymous_user == 0 %}
						</form>
						
					<div>
						<div id={{ child_comment.id }} style="display:none">
							<form method="POST" action="/dataedit/view/{{ schema }}/{{ table }}">
								{% csrf_token %}
								<input type="hidden"  name="CommentID" value = {{ child_comment.id }}  >
								<textarea id="summernote"  placeholder='Replying to {{ child_comment.user }}' name='content' style="width=100%; height=90px; padding: 2%; margin-left: 150px; position=absolute" required></textarea>
								<button type="submit" class="btn btn-sm btn-success" style="font-size: 7px"> Reply </button>
							</form>
						</div>
					</div>
					{% endif %}
				<ul>
				</br>
			</div>
			{% endfor %}
		</ul>
	</div>		
{% endfor %}
</div>
	
{% endblock %}

{% block main-right-sidebar-content-additional %}

  <h4>Tags</h4>

  {% load dataedit.taghandler %}
  {% get_tags table=table schema=schema as table_tags %}
  {% include 'dataedit/taggable_setting.html' with table=table schema=schema selected=table_tags %}

  <hr>

  <h4>Downloads</h4>
  <div class="btn-group btn-group-sm" role="group" aria-label="Actions">
    <a href="/api/v0/schema/{{ schema }}/tables/{{ table }}/rows?form=csv" type="button" class="btn btn-success">Download CSV</a>
    <a href="/api/v0/schema/{{ schema }}/tables/{{ table }}/rows?form=datapackage" type="button" class="btn btn-warning">Download Datapackage</a>
  </div>
  <hr>

  {% if schema == "model_draft" %}
    <h4>Uploads</h4>
    <span class="mb-2" {% if not can_add %} data-toggle="tooltip" title="You need write permissions on this table to upload data" {% endif %}>
      <a class="btn btn-sm btn-success {% if not can_add %} disabled {% endif %}" href="{% url 'wizard_upload' schema=schema table=table %}" >
        Upload CSV (Wizard)
    </a>
    </span>
    <hr>
  {% endif %}

  <h4>API Usage</h4>
  <textarea
    class="form-control" rows="6" cols="50"
    style="white-space: nowrap;font-size: 12px;resize: none;overflow-y: hidden;font-family: 'SFMono-Regular',Consolas,'Liberation Mono',Menlo,Courier,monospace;"
  >

from requests import get

result = get('https://{{ host }}/api/v0/schema/{{ schema }}/tables/{{ table }}/rows')
for row in result.json():
  # Process the row
  </textarea>
  <hr>

  <h4>Permissions</h4>
  <div class="btn-group btn-group-sm" role="group" aria-label="Actions">
    <a href="{{ table }}/permissions" type="button" class="btn btn-danger">Permissions</a>
  </div>
  <hr>
{% endblock main-right-sidebar-content-additional %}

{% block after-head %}

  <link rel="stylesheet" href="{% static 'dataedit/dataedit.css' %}">
  <link href="https://raw.githubusercontent.com/tobiasahlin/SpinKit/master/css/spinkit.css" rel="stylesheet">
  <link href="{% static 'dataedit/metadata.css' %}" rel="stylesheet">
  <link href="{% static 'dataedit/query-builder.default.min.css' %}" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
        integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
        crossorigin=""/>
  <link href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css" rel="stylesheet">

{% endblock after-head %}

{% block after-body-bottom-js %}
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
  <script src="{% static 'dataedit/wkx.min.js' %}"></script>
  <script src="{% static 'dataedit/proj4.js' %}"></script>
  <script type="text/javascript" src="{% static 'dataedit/query-builder.standalone.js' %}"></script>
  <script type="text/javascript" src="{% static 'dataedit/backend.js' %}"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://unpkg.com/json5@^2.0.0/dist/index.min.js"></script>

  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
          integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
          crossorigin=""></script>


  <script>
      var csrftoken = getCookie('csrftoken');
      var table = '{{table}}';
      var schema = '{{schema}}';
      var view = {
          type: "{{ current_view.type }}",
          options: JSON5.parse("{{ current_view.options | escapejs }}")
      };
      load_view(schema, table, csrftoken, view);
	  
	  function myFunction(id) {
			var res = document.getElementById(id);
			if ( res.style.display == "block" )
				res.style.display = "none";
			else
				res.style.display = "block";
		}

      var downloadMetadata = function () {
          var metaUrl = "/api/v0/schema/{{ schema }}/tables/{{ table }}/meta";
          $.get(metaUrl).then(function(json){
            console.log(json);
            // create data url
            var json = JSON.stringify(json, null, 1);
            console.log(json);
            blob = new Blob([json], {type: "application/json"}),
            dataUrl = URL.createObjectURL(blob);
            // create link
            var a = document.createElement("a");
            document.body.appendChild(a);
            // assign url and click
            a.style = "display: none";
            a.href = dataUrl;
            a.download = '{{ table }}.metadata.json';
            a.click();
            // cleanup
            URL.revokeObjectURL(dataUrl);
            a.parentNode.removeChild(a);
          })
      };

      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

  </script>
{% endblock after-body-bottom-js %}




