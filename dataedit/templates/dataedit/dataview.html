{% extends "dataedit/base.html" %}
{% load dataedit.metadata %}
{% load static %}
{% load django_bootstrap5 %}


{% block site-header %}
<div class="main-header">
  <h1 class="main-header__title">
      <svg width="20" height="20" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M4.31781 2.68742C3.35608 3.12457 3 3.62628 3 4C3 4.37372 3.35608 4.87543 4.31781 5.31258C5.23441 5.72922 6.53579 6 8 6C9.46421 6 10.7656 5.72922 11.6822 5.31258C12.6439 4.87543 13 4.37372 13 4C13 3.62628 12.6439 3.12457 11.6822 2.68742C10.7656 2.27078 9.46421 2 8 2C6.53579 2 5.23441 2.27078 4.31781 2.68742ZM13 5.69813C12.729 5.90046 12.4201 6.07563 12.096 6.22295C11.022 6.71114 9.57336 7 8 7C6.42664 7 4.97802 6.71114 3.90401 6.22295C3.5799 6.07563 3.27105 5.90046 3 5.69813V7C3 7.37372 3.35608 7.87543 4.31781 8.31258C5.23441 8.72922 6.53579 9 8 9C9.46421 9 10.7656 8.72922 11.6822 8.31258C12.6439 7.87543 13 7.37372 13 7V5.69813ZM14 4C14 2.993 13.1249 2.24472 12.096 1.77705C11.022 1.28886 9.57336 1 8 1C6.42664 1 4.97802 1.28886 3.90401 1.77705C2.87513 2.24472 2 2.993 2 4V13C2 14.007 2.87513 14.7553 3.90401 15.2229C4.97802 15.7111 6.42664 16 8 16C9.57336 16 11.022 15.7111 12.096 15.2229C13.1249 14.7553 14 14.007 14 13V4ZM13 8.69813C12.729 8.90046 12.4201 9.07563 12.096 9.22295C11.022 9.71114 9.57336 10 8 10C6.42664 10 4.97802 9.71114 3.90401 9.22295C3.5799 9.07563 3.27105 8.90046 3 8.69813V10C3 10.3737 3.35608 10.8754 4.31781 11.3126C5.23441 11.7292 6.53579 12 8 12C9.46421 12 10.7656 11.7292 11.6822 11.3126C12.6439 10.8754 13 10.3737 13 10V8.69813ZM13 11.6981C12.729 11.9005 12.4201 12.0756 12.096 12.2229C11.022 12.7111 9.57336 13 8 13C6.42664 13 4.97802 12.7111 3.90401 12.2229C3.5799 12.0756 3.27105 11.9005 3 11.6981V13C3 13.3737 3.35608 13.8754 4.31781 14.3126C5.23441 14.7292 6.53579 15 8 15C9.46421 15 10.7656 14.7292 11.6822 14.3126C12.6439 13.8754 13 13.3737 13 13V11.6981Z" fill="#293B46"/>
      </svg>
      Database
  </h1>
  <div class="main-header__wizard">
    <a href="/dataedit/schemas">Topics</a> / <a href="/dataedit/view/{{ schema }}">{{ schema }}</a> / {{ table }}
  </div>
</div>

<div class="table-tabs">
  <div class="table-tabs__container">
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link active" aria-current="page" href="#">Data</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">Meta information</a>
      </li>
    </ul>
  </div>
</div>
{% endblock site-header %}

{% block data_content %}
<div>
{% include 'messages.html' %}
</div>

<ul class="nav nav-tabs">
  <li class="nav-item">
    <a class="nav-link {% if current_view.type == " table" %}active{% endif %}"
      href="/dataedit/view/{{ schema }}/{{ table }}">Table</a>
  </li>
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle {% if current_view.type == " graph" %}active{% endif %}" data-bs-toggle="dropdown"
      href="#" role="button" aria-haspopup="true" aria-expanded="false">Graphs</a>
    <div class="dropdown-menu">
      {% for view in views %}
      {% if view.type == "graph" %}
      <a class="dropdown-item" href="?view={{ view.id }}">{{ view.name }}</a>
      {% endif %}
      {% endfor %}
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="/dataedit/view/{{ schema }}/{{ table }}/graph/new">Add Graph View</a>
    </div>
  </li>
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle {% if current_view.type == " map" %}active{% endif %}" data-bs-toggle="dropdown"
      href="#" role="button" aria-haspopup="true" aria-expanded="false">Maps</a>
    <div class="dropdown-menu">
      {% for view in views %}
      {% if view.type == "map" %}
      <a class="dropdown-item" href="?view={{ view.id }}">{{ view.name }}</a>
      {% endif %}
      {% endfor %}
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="/dataedit/view/{{ schema }}/{{ table }}/map/geom/new">Add gis view</a>
      <a class="dropdown-item" href="/dataedit/view/{{ schema }}/{{ table }}/map/latlon/new">Add lat/lon view</a>
    </div>
  </li>
</ul>

<div>
  <div class="datatable">
    <table class="display" id="datatable" style="width:100%">
      <thead>
        <tr></tr>
      </thead>
    </table>

    <div class="panel-group">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h4 class="panel-title">
            <a data-bs-toggle="collapse" href="#collapseBuilder">Filter dataset</a>
          </h4>
        </div>
        <div id="collapseBuilder" class="panel-collapse collapse">
          <div class="panel-body">
            <div id="builder" style="width: 100%"></div>
            <button id="btn-set" class="btn btn-success set-json" bs-target="basic">Set rules</button>
            <button id="btn-download-view" class="btn btn-success set-json" data-bs-target="basic">Download View</button>
          </div>
        </div>
      </div>
    </div>

    <div>

    </div>
    {% if current_view.type == "map" %}
    <div style='height: 800px; width: 100%;' id="map"></div>
    {% endif %}
    {% if current_view.type == "graph" %}
    <div id="datagraph"></div>
    {% endif %}
    <div id="loading-indicator" class="sk-fading-circle">
      <div class="sk-circle1 sk-circle"></div>
      <div class="sk-circle2 sk-circle"></div>
      <div class="sk-circle3 sk-circle"></div>
      <div class="sk-circle4 sk-circle"></div>
      <div class="sk-circle5 sk-circle"></div>
      <div class="sk-circle6 sk-circle"></div>
      <div class="sk-circle7 sk-circle"></div>
      <div class="sk-circle8 sk-circle"></div>
      <div class="sk-circle9 sk-circle"></div>
      <div class="sk-circle10 sk-circle"></div>
      <div class="sk-circle11 sk-circle"></div>
      <div class="sk-circle12 sk-circle"></div>
    </div>
  </div>
</div>

<div>
  <br>
  <br>
  <h4>
    Meta Information<a
      href="https://github.com/OpenEnergyPlatform/oemetadata/blob/master/metadata/latest/metadata_key_description.md" target="_blank"><i
        class="fas fa-info-circle" title="Klick to open the OEMetadata specification."></i></a>
  </h4>
  <button class="btn btn-sm btn-success" onclick="downloadMetadata();" data-bs-toggle="tooltip"
    title="Download metadata in JSON format">Download JSON</button>
  <span class="mb-2" {% if not can_add %} data-bs-toggle="tooltip"
    title="You need write permissions on this table to edit metadata" {% endif %}>
    <a href="{{table}}/meta_edit" type="button"
      class="btn btn-success btn-sm {% if not can_add %} disabled {% endif %}">Edit</a>
  </span>

  {{ meta_widget }}
</div>
{% endblock %}

{% block main-right-sidebar-content-additional %}

<h4>Tags</h4>

{% load dataedit.taghandler %}
{% get_tags table=table schema=schema as table_tags %}
{% include 'dataedit/taggable_setting.html' with table=table schema=schema selected=table_tags %}

<hr>

<h4>Downloads</h4>
<div class="btn-group btn-group-sm" role="group" aria-label="Actions">
  <a href="/api/v0/schema/{{ schema }}/tables/{{ table }}/rows?form=csv" type="button" class="btn btn-success">Download
    CSV</a>
  <a href="/api/v0/schema/{{ schema }}/tables/{{ table }}/rows?form=datapackage" type="button"
    class="btn btn-warning">Download Datapackage</a>
</div>
<hr>

{% if schema == "model_draft" %}
<h4>Uploads</h4>
<span class="mb-2" {% if not can_add %} data-bs-toggle="tooltip"
  title="You need write permissions on this table to upload data" {% endif %}>
  <a class="btn btn-sm btn-success {% if not can_add %} disabled {% endif %}"
    href="{% url 'wizard_upload' schema=schema table=table %}">
    Upload CSV (Wizard)
  </a>
</span>
<hr>
{% endif %}

<h4>API Usage</h4>
<textarea class="form-control" rows="6" cols="50"
  style="white-space: nowrap;font-size: 12px;resize: none;overflow-y: hidden;font-family: 'SFMono-Regular',Consolas,'Liberation Mono',Menlo,Courier,monospace;">
from requests import get

result = get('https://{{ host }}/api/v0/schema/{{ schema }}/tables/{{ table }}/rows')
for row in result.json():
  # Process the row
  </textarea>
<hr>

<h4>Permissions</h4>
<div class="btn-group btn-group-sm" role="group" aria-label="Actions">
  <a href="{{ table }}/permissions" type="button" class="btn btn-danger">Permissions</a>
</div>
<hr>

{% endblock main-right-sidebar-content-additional %}

{% block after-head %}

<link href="{% static 'dataedit/dataedit.css' %}" rel="stylesheet" >
<link href="{% static 'dataedit/metadata.css' %}" rel="stylesheet">
<link href="{% static 'dataedit/query-builder.default.min.css' %}" rel="stylesheet">
<link href="{% static 'dataedit/leaflet.css' %}" rel="stylesheet"><!-- src: https://unpkg.com/leaflet@1.3.1/dist/leaflet.css -->
<link href="{% static 'dataedit/jquery.dataTables.min.css' %}" rel="stylesheet"><!-- src: https://cdn.datatables.net/1.10.20/css/jimages/query.dataTables.min.css -->

{% endblock after-head %}

{% block after-body-bottom-js %}
<script src="{% static 'dataedit/jquery.dataTables.min.js' %}"></script><!-- src: https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js -->
<script src="{% static 'dataedit/wkx.min.js' %}"></script>
<script src="{% static 'dataedit/proj4.min.js' %}"></script><!-- src: https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js -->
<script src="{% static 'dataedit/query-builder.standalone.js' %}"></script>
<script src="{% static 'dataedit/backend.js' %}"></script>
<script src="{% static 'dataedit/plotly-latest.min.js' %}"></script><!-- src: https://unpkg.com/json5@^2.0.0/dist/index.min.js -->
<script src="{% static 'dataedit/json5.min.js' %}"></script><!-- src: https://unpkg.com/json5@^2.0.0/dist/index.min.js -->

<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="{% static 'dataedit/leaflet.min.js' %}"></script><!-- src: https://unpkg.com/leaflet@1.3.1/dist/leaflet.js -->


<script>
  var csrftoken = getCookie('csrftoken');
  var table = '{{table}}';
  var schema = '{{schema}}';
  var view = {
    type: "{{ current_view.type }}",
    options: JSON5.parse("{{ current_view.options | escapejs }}")
  };
  load_view(schema, table, csrftoken, view);

  var downloadMetadata = function () {
    var metaUrl = "/api/v0/schema/{{ schema }}/tables/{{ table }}/meta";
    $.get(metaUrl).then(function (json) {
      console.log(json);
      // create data url
      var json = JSON.stringify(json, null, 1);
      console.log(json);
      blob = new Blob([json], { type: "application/json" }),
        dataUrl = URL.createObjectURL(blob);
      // create link
      var a = document.createElement("a");
      document.body.appendChild(a);
      // assign url and click
      a.style = "display: none";
      a.href = dataUrl;
      a.download = '{{ table }}.metadata.json';
      a.click();
      // cleanup
      URL.revokeObjectURL(dataUrl);
      a.parentNode.removeChild(a);
    })
  };

  $(function () {
    $('[data-bs-toggle="tooltip"]').tooltip()
  })
</script>
{% endblock after-body-bottom-js %}
