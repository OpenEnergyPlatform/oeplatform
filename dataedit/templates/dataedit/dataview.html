{% extends "dataedit/base-sidebar.html" %}
{% load dataedit.metadata %}
{% load static %}
{% load django_bootstrap5 %}
{% load compress %}


{% block site-header %}
<div class="main-header">
  <h1 class="main-header__title">
      <svg width="20" height="20" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M4.31781 2.68742C3.35608 3.12457 3 3.62628 3 4C3 4.37372 3.35608 4.87543 4.31781 5.31258C5.23441 5.72922 6.53579 6 8 6C9.46421 6 10.7656 5.72922 11.6822 5.31258C12.6439 4.87543 13 4.37372 13 4C13 3.62628 12.6439 3.12457 11.6822 2.68742C10.7656 2.27078 9.46421 2 8 2C6.53579 2 5.23441 2.27078 4.31781 2.68742ZM13 5.69813C12.729 5.90046 12.4201 6.07563 12.096 6.22295C11.022 6.71114 9.57336 7 8 7C6.42664 7 4.97802 6.71114 3.90401 6.22295C3.5799 6.07563 3.27105 5.90046 3 5.69813V7C3 7.37372 3.35608 7.87543 4.31781 8.31258C5.23441 8.72922 6.53579 9 8 9C9.46421 9 10.7656 8.72922 11.6822 8.31258C12.6439 7.87543 13 7.37372 13 7V5.69813ZM14 4C14 2.993 13.1249 2.24472 12.096 1.77705C11.022 1.28886 9.57336 1 8 1C6.42664 1 4.97802 1.28886 3.90401 1.77705C2.87513 2.24472 2 2.993 2 4V13C2 14.007 2.87513 14.7553 3.90401 15.2229C4.97802 15.7111 6.42664 16 8 16C9.57336 16 11.022 15.7111 12.096 15.2229C13.1249 14.7553 14 14.007 14 13V4ZM13 8.69813C12.729 8.90046 12.4201 9.07563 12.096 9.22295C11.022 9.71114 9.57336 10 8 10C6.42664 10 4.97802 9.71114 3.90401 9.22295C3.5799 9.07563 3.27105 8.90046 3 8.69813V10C3 10.3737 3.35608 10.8754 4.31781 11.3126C5.23441 11.7292 6.53579 12 8 12C9.46421 12 10.7656 11.7292 11.6822 11.3126C12.6439 10.8754 13 10.3737 13 10V8.69813ZM13 11.6981C12.729 11.9005 12.4201 12.0756 12.096 12.2229C11.022 12.7111 9.57336 13 8 13C6.42664 13 4.97802 12.7111 3.90401 12.2229C3.5799 12.0756 3.27105 11.9005 3 11.6981V13C3 13.3737 3.35608 13.8754 4.31781 14.3126C5.23441 14.7292 6.53579 15 8 15C9.46421 15 10.7656 14.7292 11.6822 14.3126C12.6439 13.8754 13 13.3737 13 13V11.6981Z" fill="#293B46"/>
      </svg>
      Database
  </h1>
  <div class="main-header__wizard">
    <a href="/dataedit/schemas">Topics</a> / <a href="/dataedit/view/{{ schema }}">{{ schema }}</a> / {% if table_label %} {{ table_label }} {% else %} {{ table }} {% endif %}
    <!-- Indicate weather the user got permissions fot this table -->
    {% if can_add %}
      <span class="success-badge">
        You can edit this table.
      </span>
    {% endif %}
  </div>
</div>

<div class="table-tabs">
  <div class="table-tabs__container" id="tableTabsContainer">
    <ul class="nav nav-tabs" id="tableTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="table-tab" data-bs-toggle="tab" data-bs-target="#table-tab-pane" type="button" role="tab" aria-controls="table-tab-pane" aria-selected="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"  viewBox="0 0 16 16">
            <path d="M0 1.5A1.5 1.5 0 0 1 1.5 0h13A1.5 1.5 0 0 1 16 1.5v13a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-13zM1.5 1a.5.5 0 0 0-.5.5V5h4V1H1.5zM5 6H1v4h4V6zm1 4h4V6H6v4zm-1 1H1v3.5a.5.5 0 0 0 .5.5H5v-4zm1 0v4h4v-4H6zm5 0v4h3.5a.5.5 0 0 0 .5-.5V11h-4zm0-1h4V6h-4v4zm0-5h4V1.5a.5.5 0 0 0-.5-.5H11v4zm-1 0V1H6v4h4z"/>
          </svg>
          Data
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="metadata-tab" data-bs-toggle="tab" data-bs-target="#metadata-tab-pane" type="button" role="tab" aria-controls="metadata-tab-pane" aria-selected="false">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
          </svg>
          Meta information
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="OPR-tab" data-bs-toggle="tab" data-bs-target="#opr-tab-pane" type="button" role="tab" aria-controls="metadata-tab-pane" aria-selected="false">
          <svg height="16" width="16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
            <path d="m13.68 4.8867c-7.5234 0-13.68 6.1562-13.68 13.676v44.527c0 7.5195 6.1562 13.676 13.68 13.676h4.6797v15.223c0 1.2617 0.76172 2.4023 1.9258 2.8867 1.1641 0.48438 2.5078 0.21875 3.4023-0.66797l17.461-17.438h45.195c7.5195 0 13.652-6.1562 13.652-13.68l0.003906-44.527c0-7.5195-6.1328-13.68-13.652-13.68zm0 6.25h72.668c4.1641 0 7.4023 3.2617 7.4023 7.4297v44.523c0 4.1641-3.2383 7.4297-7.4023 7.4297h-46.484v-0.003906c-0.82812-0.003906-1.625 0.31641-2.2188 0.89844l-13.035 13.039v-10.824c-0.007813-1.7148-1.3984-3.1055-3.1133-3.1133h-7.8203c-4.1641 0-7.4297-3.2617-7.4297-7.4297l0.003906-44.523c0-4.1641 3.2617-7.4297 7.4297-7.4297zm36.285 9.4102c-1.2617 0.019531-2.3906 0.79297-2.8594 1.9648l-4.0391 10.055-10.816 0.73828c-1.2734 0.082031-2.3711 0.93359-2.7656 2.1484-0.39844 1.2148-0.015625 2.5508 0.96484 3.3672l8.3242 6.9414-2.6562 10.523h0.003906c-0.32031 1.2422 0.15234 2.5586 1.1914 3.3086 1.043 0.75391 2.4375 0.79688 3.5195 0.10156l9.1797-5.7695 9.1797 5.7695c1.082 0.67188 2.4609 0.62109 3.4922-0.12891 1.0273-0.75 1.4961-2.0469 1.1914-3.2812l-2.6328-10.523 8.3086-6.9414c0.97656-0.81641 1.3633-2.1445 0.97266-3.3555-0.39063-1.2148-1.4805-2.0703-2.75-2.1602l-10.82-0.73828-4.0352-10.055c-0.48047-1.2031-1.6562-1.9844-2.9531-1.9648zm0.046875 11.512 1.8672 4.6641c0.44922 1.1016 1.4883 1.8516 2.6758 1.9336l5.0547 0.34766-3.875 3.2305h-0.003906c-0.92578 0.76562-1.3281 1.9961-1.0391 3.1602l1.2188 4.8633-4.2422-2.6719h0.003906c-1.0156-0.63672-2.3047-0.63672-3.3203 0l-4.2734 2.6719 1.2266-4.8633c0.29687-1.1602-0.10156-2.3906-1.0195-3.1602l-3.875-3.2305 5.0312-0.34766c1.1953-0.070312 2.2461-0.82422 2.7031-1.9336z"/>
          </svg>
          Open Peer Review
        </button>
      </li>
    </ul>
    <div id="toggleContentSideContainer">
      <button class="btn btn-link" id="toggleContentSideBtn">Hide options</button>
    </div>
  </div>
</div>
{% endblock site-header %}

{% block data_content %}
<div>
{% include 'messages.html' %}
</div>

<div class="tab-content" id="tableTabsContent">
  <div class="tab-pane fade show active" id="table-tab-pane" role="tabpanel" aria-labelledby="table-tab" tabindex="0">
  {% if embargo_time_left != "No embargo data available" and embargo_time_left != "The embargo is over" %}
      <div class="embargo-message">
        <p>Data in embargo zone</p>

        {% if embargo_time_left != "No embargo data available" and embargo_time_left != "The embargo is over" %}
        <div class="embargo-message">
          <p>Embargo time left {{ embargo_time_left }}</p>
        </div>
        {% endif %}
      </div>
    {% else %}
    <div class="data-view">
      <span class="data-view__label">View</span>
      <ul class="nav nav-tabs data-view__tabs">
        <li class="nav-item data-view__tab">
          <a class="nav-link data-view__link {% if current_view.type == " table" %}active{% endif %}"
            href="/dataedit/view/{{ schema }}/{{ table }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-layout-text-window-reverse" viewBox="0 0 16 16">
              <path d="M13 6.5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 .5-.5zm0 3a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 .5-.5zm-.5 2.5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1h5z"/>
              <path d="M14 0a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h12zM2 1a1 1 0 0 0-1 1v1h14V2a1 1 0 0 0-1-1H2zM1 4v10a1 1 0 0 0 1 1h2V4H1zm4 0v11h9a1 1 0 0 0 1-1V4H5z"/>
            </svg>
            Table
          </a>
        </li>
        <li class="nav-item dropdown data-view__tab">
          <a class="nav-link data-view__link dropdown-toggle {% if current_view.type == " graph" %}active{% endif %}" data-bs-toggle="dropdown"
            href="#" role="button" aria-haspopup="true" aria-expanded="false">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-graph-up" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M0 0h1v15h15v1H0V0Zm14.817 3.113a.5.5 0 0 1 .07.704l-4.5 5.5a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61 4.15-5.073a.5.5 0 0 1 .704-.07Z"/>
            </svg>
            Graphs
          </a>
          <div class="dropdown-menu">
            {% for view in views %}
            {% if view.type == "graph" %}
            <a class="dropdown-item" href="?view={{ view.id }}">{{ view.name }}</a>
            {% endif %}
            {% endfor %}
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="/dataedit/view/{{ schema }}/{{ table }}/graph/new">Add Graph View</a>
          </div>
        </li>
        <li class="nav-item dropdown data-view__tab">
          <a class="nav-link data-view__link dropdown-toggle {% if current_view.type == " map" %}active{% endif %}" data-bs-toggle="dropdown"
            href="#" role="button" aria-haspopup="true" aria-expanded="false">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-geo-alt" viewBox="0 0 16 16">
              <path d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A31.493 31.493 0 0 1 8 14.58a31.481 31.481 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94zM8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10z"/>
              <path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 1a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
            </svg>
            Maps
          </a>
          <div class="dropdown-menu">
            {% for view in views %}
            {% if view.type == "map" %}
            <a class="dropdown-item" href="?view={{ view.id }}">{{ view.name }}</a>
            {% endif %}
            {% endfor %}
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="/dataedit/view/{{ schema }}/{{ table }}/map/geom/new">Add gis view</a>
            <a class="dropdown-item" href="/dataedit/view/{{ schema }}/{{ table }}/map/latlon/new">Add lat/lon view</a>
          </div>
        </li>
      </ul>
    </div>
    <div>
      <div class="datatable">
        <table class="display" id="datatable" style="width:100%">
          <thead>
            <tr>
            </tr>
          </thead>
        </table>

        <div class="panel-group">
          <div class="panel panel-default">
            <div class="panel-heading">
              <p class="panel-title">
                <a data-bs-toggle="collapse" href="#collapseBuilder">Filter dataset</a>
              </p>
            </div>
            <div id="collapseBuilder" class="panel-collapse collapse">
              <div class="panel-body">
                <div id="builder" style="width: 100%"></div>
                <button id="btn-set" class="btn btn-success set-json" bs-target="basic">Set rules</button>
                <button id="btn-download-view" class="btn btn-success set-json" data-bs-target="basic">Download View</button>
              </div>
            </div>
          </div>
        </div>

        <div>

        </div>
        {% if current_view.type == "map" %}
        <div style='height: 800px; width: 100%;' id="map"></div>
        {% endif %}
        {% if current_view.type == "graph" %}
        <div id="datagraph"></div>
        {% endif %}
        <div id="loading-indicator" class="sk-fading-circle">
          <div class="sk-circle1 sk-circle"></div>
          <div class="sk-circle2 sk-circle"></div>
          <div class="sk-circle3 sk-circle"></div>
          <div class="sk-circle4 sk-circle"></div>
          <div class="sk-circle5 sk-circle"></div>
          <div class="sk-circle6 sk-circle"></div>
          <div class="sk-circle7 sk-circle"></div>
          <div class="sk-circle8 sk-circle"></div>
          <div class="sk-circle9 sk-circle"></div>
          <div class="sk-circle10 sk-circle"></div>
          <div class="sk-circle11 sk-circle"></div>
          <div class="sk-circle12 sk-circle"></div>
        </div>
      </div>
    </div>
   {% endif %}
  </div>
  <div class="tab-pane metadata fade" id="metadata-tab-pane" role="tabpanel" aria-labelledby="metadata-tab" tabindex="0">
    <div class="metadata__options">
      <span class="me-3">
        <a href="https://github.com/OpenEnergyPlatform/oemetadata/blob/production/oemetadata/latest/metadata_key_description.md" target="_blank" title="Click to open the OEMetadata specification">
          <i class="fas fa-arrow-right"></i>
          Metadata specification
        </a>
      </span>
      <button onclick="downloadMetadata();" data-bs-toggle="tooltip" title="Download metadata in JSON format"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-2" viewBox="0 0 16 16">
        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
      </svg>Download JSON</button>
      
      <span {% if not can_add or opr.opr_id and not opr.is_finished %} data-bs-toggle="tooltip" title="You need write permissions on this table to edit metadata. If you have permissions it is likely that a metadata review is in progress, data can't be changed during ongoing Open Peer Reviews." {% endif %}>
    <a href="{{table}}/meta_edit" type="button" class="btn btn-primary btn-sm {% if not can_add or opr.opr_id and not opr.is_finished %} disabled {% endif %}">
      Edit
    </a>
    </span>
  </div>
  <div 
  hx-get="{% url 'dataedit:metadata-widget' %}"
  hx-trigger="revealed once"
  hx-vals='{"schema": "{{schema}}", "table": "{{table}}"}'
  hx-target="#metadata-container">
  </div>

  <div id="metadata-container"></div>

</div>

  <div class="tab-pane opr fade" id="opr-tab-pane" role="tabpanel" aria-labelledby="opr-tab" tabindex="0">
    <div class="opr__info">
      The Open Peer Review system plays a crucial role in ensuring the integrity of metadata on the OpenEnergyPlatform.
      By adopting a community-driven approach to peer review, we empower users to actively participate in maintaining
      high-quality standards, much like the collaborative model used by Wikipedia to safeguard the quality of its articles.
      <br><br>
      Interested users can easily step into the role of a reviewer and scrutinize metadata submitted by data publishers.
      However, reviewing metadata is not a simple task. Prospective reviewers should have a solid understanding of the
      <a href="https://openenergyplatform.github.io/organisation/family_members/templates-and-specification/open-energy-metadata/" target="_blank">OEMetadata specification </a> and be well-versed in the FAIR principles (Findability, Accessibility, Interoperability,
      and Reusability). This knowledge base ensures that reviews are both thorough and uphold the platform's commitment
      to data excellence.
      <br><br>
      <span class="early-access">
        Early Access
      </span>
      <br>
      This feature is not yet complete and currently is only available for testing and feedback purposes.
    </div>
    {% if not opr.reviewer %}
    <div class="alert alert-variant--warning alert-variant--sm alert-variant--center" role="alert">
      <span class="alert-variant__content">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
          <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1-.054-.06.18.18 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z"/>
          <path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
        </svg>
        Not reviewed
      </span>
    </div>
    {% endif %}

    {% if opr.reviewer and not opr_result.finished %}
    <div class="alert alert-variant--info alert-variant--sm alert-variant--center" role="alert">
      <span class="alert-variant__content">Under review</span>
    </div>
    {% endif %}


    {% if opr_result.finished %}
    <div class="alert alert-variant--info alert-variant--sm alert-variant--center" role="alert">
      <span class="alert-variant__content">Latest review completed</span>
    </div>
    {% endif %}



    {% if opr_result.review_exists %}
    <div class="table-container">
      <table>
        <tbody>
          <tr>
            <th>Finished</th>
            <td>{{ opr_result.date_finished }}</td>
          </tr>
          <tr>
            <th>Reviewer</th>
            <td><a>{{ opr.reviewer.name }}</a></td>
          </tr>
          <tr>
            <th>Badge</th>
            <td>{{ opr_result.badge }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <a class="btn btn-primary" href="{% url 'dataedit:peer_review_reviewer' table=table schema=schema review_id=opr_result.review_id %}">Review details</a>
    {% endif %}

    <!-- If user is not the data contributor  -->
    {% if not opr.is_finished and user.is_authenticated %}
    {% if opr.contributor.id != user.id and not opr.reviewer %}
    <div class="table-sidebar__section">
    {% if opr.opr_enabled %}
      <button type="button" class="table-sidebar__btn-review table-sidebar__btn-review--start" id="opr-button-start" data-url="{% url 'dataedit:peer_review_create' table=table schema=schema %}">
        <svg height="16" width="16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
          <path d="m13.68 4.8867c-7.5234 0-13.68 6.1562-13.68 13.676v44.527c0 7.5195 6.1562 13.676 13.68 13.676h4.6797v15.223c0 1.2617 0.76172 2.4023 1.9258 2.8867 1.1641 0.48438 2.5078 0.21875 3.4023-0.66797l17.461-17.438h45.195c7.5195 0 13.652-6.1562 13.652-13.68l0.003906-44.527c0-7.5195-6.1328-13.68-13.652-13.68zm0 6.25h72.668c4.1641 0 7.4023 3.2617 7.4023 7.4297v44.523c0 4.1641-3.2383 7.4297-7.4023 7.4297h-46.484v-0.003906c-0.82812-0.003906-1.625 0.31641-2.2188 0.89844l-13.035 13.039v-10.824c-0.007813-1.7148-1.3984-3.1055-3.1133-3.1133h-7.8203c-4.1641 0-7.4297-3.2617-7.4297-7.4297l0.003906-44.523c0-4.1641 3.2617-7.4297 7.4297-7.4297zm36.285 9.4102c-1.2617 0.019531-2.3906 0.79297-2.8594 1.9648l-4.0391 10.055-10.816 0.73828c-1.2734 0.082031-2.3711 0.93359-2.7656 2.1484-0.39844 1.2148-0.015625 2.5508 0.96484 3.3672l8.3242 6.9414-2.6562 10.523h0.003906c-0.32031 1.2422 0.15234 2.5586 1.1914 3.3086 1.043 0.75391 2.4375 0.79688 3.5195 0.10156l9.1797-5.7695 9.1797 5.7695c1.082 0.67188 2.4609 0.62109 3.4922-0.12891 1.0273-0.75 1.4961-2.0469 1.1914-3.2812l-2.6328-10.523 8.3086-6.9414c0.97656-0.81641 1.3633-2.1445 0.97266-3.3555-0.39063-1.2148-1.4805-2.0703-2.75-2.1602l-10.82-0.73828-4.0352-10.055c-0.48047-1.2031-1.6562-1.9844-2.9531-1.9648zm0.046875 11.512 1.8672 4.6641c0.44922 1.1016 1.4883 1.8516 2.6758 1.9336l5.0547 0.34766-3.875 3.2305h-0.003906c-0.92578 0.76562-1.3281 1.9961-1.0391 3.1602l1.2188 4.8633-4.2422-2.6719h0.003906c-1.0156-0.63672-2.3047-0.63672-3.3203 0l-4.2734 2.6719 1.2266-4.8633c0.29687-1.1602-0.10156-2.3906-1.0195-3.1602l-3.875-3.2305 5.0312-0.34766c1.1953-0.070312 2.2461-0.82422 2.7031-1.9336z"/>
        </svg>
        Start Open Peer Review
        <span class="early-access">
          Early Access
          <span class="visually-hidden">This feature is not complete. You can test the current functionality but you should expect errors.</span>
        </span>
      </button>
    </div>
        {% else %}
      <button class="btn btn-success btn-sm disabled" type="button">
        Start Open-Peer-Review-Process
      </button>
      <i class="fas fa-info-circle" data-toggle="tooltip" data-placement="top" title="Metadata required to start review is not present."></i>
    {% endif %}
    
    {% endif %}

    <!-- If user is the data contributor & no review has started yet-->
    {% if can_add and not opr.reviewer %}
    <!-- TODO: Remove style="display: none;" once the request view is implemented -->
    <div class="table-sidebar__section" style="display: none;">
      <button type="button" class="table-sidebar__btn-review table-sidebar__btn-review--request" id="opr-button-request" data-url="">
        <svg height="16" width="16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
          <g>
            <path d="m42.285 35.898c0-0.49609 0.039063-0.98438 0.10938-1.4844-0.039062 0.26563-0.070312 0.51563-0.10938 0.78125 0.13672-0.91016 0.38281-1.7891 0.73438-2.6367-0.097656 0.23438-0.19531 0.46875-0.29297 0.70312 0.27344-0.625 0.59375-1.2305 0.97656-1.7969 0.039063-0.046875 0.24219-0.42188 0.29297-0.42188-0.058594 0-0.52734 0.66406-0.14844 0.19531 0.21484-0.26562 0.4375-0.50781 0.68359-0.75 0.24219-0.24219 0.48828-0.46875 0.75-0.68359 0.1875-0.14844 0.57812-0.37109-0.19531 0.14844 0.13672-0.097656 0.27344-0.20312 0.42187-0.29297 0.56641-0.38281 1.1719-0.70312 1.7969-0.97656-0.23438 0.097656-0.46875 0.19531-0.70313 0.29297 0.84766-0.35156 1.7266-0.59375 2.6367-0.73437-0.26562 0.039062-0.51562 0.070312-0.78125 0.10937 0.98438-0.125 1.9727-0.125 2.9609 0-0.26562-0.039062-0.51562-0.070312-0.78125-0.10937 0.91016 0.13672 1.7891 0.38281 2.6367 0.73437-0.23438-0.097656-0.46875-0.19531-0.70313-0.29297 0.625 0.27344 1.2305 0.59375 1.7969 0.97656 0.046874 0.039063 0.42187 0.24219 0.42187 0.29297 0-0.058594-0.66406-0.52734-0.19531-0.14844 0.26562 0.21484 0.50781 0.4375 0.75 0.68359 0.24219 0.24219 0.46875 0.48828 0.68359 0.75 0.14844 0.1875 0.37109 0.57812-0.14844-0.19531 0.097656 0.13672 0.20312 0.27344 0.29297 0.42188 0.38281 0.56641 0.70312 1.1719 0.97656 1.7969-0.097657-0.23438-0.19531-0.46875-0.29297-0.70312 0.35156 0.84766 0.59375 1.7266 0.73438 2.6367-0.039063-0.26562-0.070313-0.51562-0.10938-0.78125 0.13672 0.98438 0.125 1.9844 0 2.9688 0.039062-0.26562 0.070312-0.51562 0.10938-0.78125-0.13672 0.91016-0.38281 1.7969-0.73438 2.6484 0.097656-0.23438 0.19531-0.46875 0.29297-0.70312-0.30469 0.69531-0.66406 1.3594-1.1016 1.9727-0.42969 0.61719 0.35156-0.41016 0.03125-0.03125-0.11719 0.14844-0.24219 0.28125-0.35938 0.42969-0.25391 0.27344-0.51562 0.54688-0.80078 0.78906-0.13672 0.125-0.29297 0.23438-0.42969 0.35938 0.67188-0.64453 0.24219-0.1875 0.03125-0.039062-0.3125 0.21484-0.63281 0.39844-0.95703 0.59375-0.8125 0.48828-1.582 1.0859-2.2852 1.7266-2.7344 2.5078-4.2578 6.1719-4.2891 9.875-0.007812 1.5312 1.3594 3 2.9297 2.9297 1.5938-0.070313 2.9219-1.2891 2.9297-2.9297 0-0.49609 0.039063-0.99609 0.10938-1.4922-0.039062 0.26562-0.070312 0.51562-0.10938 0.78125 0.13672-0.91016 0.38281-1.7969 0.73438-2.6484-0.097656 0.23438-0.19531 0.46875-0.29297 0.70312 0.17578-0.41016 0.38281-0.82031 0.60547-1.2031 0.10938-0.1875 0.21484-0.35938 0.34375-0.53906 0.070313-0.097657 0.13672-0.19531 0.20312-0.29297 0.35938-0.49609-0.3125 0.38281-0.11719 0.14844 0.28125-0.34375 0.57812-0.67188 0.89844-0.98438 0.15625-0.14844 0.30469-0.29297 0.46875-0.42969 0.078125-0.070313 0.17578-0.1875 0.27344-0.22266-0.125 0.097656-0.24219 0.1875-0.37109 0.28125 0.078125-0.058594 0.14844-0.11719 0.22266-0.16406 0.89844-0.64453 1.8359-1.1719 2.7031-1.8555 0.8125-0.63281 1.4766-1.375 2.1094-2.1875 2.6758-3.457 3.5742-8.2344 2.1562-12.402-1.3594-4.0156-4.375-7.0508-8.3203-8.5547-3.7383-1.4258-8.2422-0.89844-11.621 1.2109-3.9648 2.4805-6.4141 6.8359-6.4453 11.523-0.007813 1.5312 1.3594 3 2.9297 2.9297 1.6289-0.074219 2.9453-1.2852 2.957-2.9258z"/>
            <path d="m52.82 65.672v-2.625c0-1.5312-1.3477-3-2.9297-2.9297-1.5938 0.070312-2.9297 1.2891-2.9297 2.9297v2.625c0 1.5312 1.3477 3 2.9297 2.9297 1.5938-0.078124 2.9297-1.2891 2.9297-2.9297z"/>
            <path d="m76.816 74.512h-14.434c-0.63281 0-1.2812-0.019531-1.9141 0-1.4844 0.039062-2.0508 0.80078-2.832 1.7578-1.7969 2.1562-3.5938 4.3047-5.3828 6.4648-1.4453 1.7266-2.8828 3.457-4.3281 5.1953h4.1406c-1.2188-1.4648-2.4414-2.9297-3.6523-4.3828-1.8945-2.2734-3.7891-4.5391-5.6836-6.8164-0.37109-0.4375-0.71094-0.92969-1.125-1.3477-0.97656-0.99609-2.2852-0.85937-3.5352-0.85937h-8.6914c-2.0625 0-4.1211 0.007812-6.1797 0-0.32031 0-0.64453-0.019532-0.96875-0.070313 0.26562 0.039063 0.51562 0.070313 0.78125 0.10938-0.60547-0.085938-1.1914-0.25391-1.7695-0.48828 0.23437 0.097656 0.46875 0.19531 0.70312 0.29297-0.39062-0.17578-0.77344-0.37109-1.1328-0.61719-0.070312-0.046875-0.13672-0.097656-0.20312-0.14844-0.41016-0.28125 0.44922 0.39063 0.24219 0.1875-0.14844-0.14844-0.32031-0.28125-0.46875-0.42969-0.13672-0.13672-0.26562-0.28125-0.39062-0.42188-0.34375-0.35938 0.34375 0.48828 0.17578 0.24219-0.058594-0.085938-0.125-0.17578-0.1875-0.26563-0.24219-0.35937-0.4375-0.73437-0.61719-1.1328 0.097657 0.23438 0.19531 0.46875 0.29297 0.70312-0.23438-0.56641-0.39844-1.1523-0.48828-1.7695 0.039062 0.26562 0.070312 0.51562 0.10938 0.78125-0.097656-0.72266-0.070313-1.4648-0.070313-2.1953v-3.8477-12.883-15.789-13.496c0-2.1094-0.007812-4.2188 0-6.3203 0-0.33203 0.019531-0.65625 0.070313-0.98438-0.039063 0.26562-0.070313 0.51562-0.10938 0.78125 0.085937-0.60547 0.25391-1.1914 0.48828-1.7695-0.097656 0.23437-0.19531 0.46875-0.29297 0.70312 0.17578-0.39062 0.37109-0.77344 0.61719-1.1328 0.046875-0.070312 0.097656-0.13672 0.14844-0.20312 0.28125-0.41016-0.39062 0.44922-0.1875 0.24219 0.14844-0.14844 0.28125-0.32031 0.42969-0.46875 0.13672-0.13672 0.28125-0.26562 0.42188-0.39062 0.35938-0.34375-0.48828 0.34375-0.24219 0.17578 0.085938-0.058594 0.17578-0.125 0.26562-0.1875 0.35938-0.24219 0.73438-0.4375 1.1328-0.61719-0.23438 0.097657-0.46875 0.19531-0.70312 0.29297 0.56641-0.23438 1.1523-0.39844 1.7695-0.48828-0.26562 0.039062-0.51562 0.070312-0.78125 0.10938 0.72266-0.097656 1.4648-0.070313 2.1953-0.070313h3.8477 12.883 15.789 13.496c2.1094 0 4.2188-0.007812 6.3203 0 0.33203 0 0.65625 0.019531 0.98438 0.070313-0.26562-0.039063-0.51562-0.070313-0.78125-0.10938 0.60547 0.085937 1.1914 0.25391 1.7695 0.48828-0.23438-0.097656-0.46875-0.19531-0.70312-0.29297 0.39062 0.17578 0.77344 0.37109 1.1328 0.61719 0.070312 0.046875 0.13672 0.097656 0.20312 0.14844 0.41016 0.28125-0.44922-0.39062-0.24219-0.1875 0.14844 0.14844 0.32031 0.28125 0.46875 0.42969 0.13672 0.13672 0.26562 0.28125 0.39062 0.42188 0.34375 0.35938-0.34375-0.48828-0.17578-0.24219 0.058594 0.085938 0.125 0.17578 0.1875 0.26562 0.24219 0.35938 0.4375 0.73438 0.61719 1.1328-0.097657-0.23438-0.19531-0.46875-0.29297-0.70312 0.23438 0.56641 0.39844 1.1523 0.48828 1.7695-0.039062-0.26562-0.070312-0.51562-0.10938-0.78125 0.097656 0.72266 0.070313 1.4648 0.070313 2.1953v3.8477 12.883 15.789 13.496c0 2.1094 0.007812 4.2188 0 6.3203 0 0.33203-0.019532 0.65625-0.070313 0.98438 0.039063-0.26562 0.070313-0.51562 0.10938-0.78125-0.085938 0.60547-0.25391 1.1914-0.48828 1.7695 0.097656-0.23438 0.19531-0.46875 0.29297-0.70312-0.17578 0.39062-0.37109 0.77344-0.61719 1.1328-0.046875 0.070312-0.097656 0.13672-0.14844 0.20312-0.28125 0.41016 0.39063-0.44922 0.1875-0.24219-0.14844 0.14844-0.28125 0.32031-0.42969 0.46875-0.13672 0.13672-0.28125 0.26562-0.42188 0.39062-0.35938 0.34375 0.48828-0.34375 0.24219-0.17578-0.085938 0.058594-0.17578 0.125-0.26563 0.1875-0.35937 0.24219-0.73437 0.4375-1.1328 0.61719 0.23438-0.097657 0.46875-0.19531 0.70312-0.29297-0.56641 0.23438-1.1523 0.39844-1.7695 0.48828 0.26562-0.039062 0.51562-0.070312 0.78125-0.10938-0.29297 0.039063-0.60547 0.058594-0.92969 0.058594-1.5312 0.019531-3 1.3359-2.9297 2.9297 0.070312 1.5742 1.2891 2.9492 2.9297 2.9297 4.4062-0.039063 8.4453-3.0781 9.5234-7.3906 0.27344-1.0938 0.3125-2.1797 0.3125-3.293v-7.9688-13.133-14.52-11.805c0-1.7695 0.007812-3.543 0-5.3125-0.03125-3.6523-2.1172-7.2344-5.4688-8.8203-1.582-0.75-3.2227-1.0352-4.9531-1.0352h-7.4219-12.938-14.512-12.141-5.9297c-3.3477 0.007812-6.2695 1.6211-8.2109 4.3047-1.2422 1.6992-1.7188 3.8203-1.7188 5.8906v6.875 12.664 14.531 12.441 6.5156c0 2.6367 0.92969 5.125 2.7539 7.0508 1.3672 1.4453 3.3125 2.5312 5.293 2.8438 0.8125 0.125 1.582 0.17578 2.3906 0.17578h12.441 3.3203c-0.69531-0.28125-1.375-0.57812-2.0703-0.85938 3.0547 3.6719 6.1133 7.332 9.1719 11.008 0.42969 0.51562 0.85938 1.0234 1.2891 1.543 0.94531 1.1406 3.1953 1.1328 4.1406 0 3.0547-3.6719 6.1133-7.332 9.1719-11.008 0.42969-0.51562 0.85938-1.0234 1.2891-1.543-0.69531 0.28125-1.375 0.57812-2.0703 0.85938h14.367 2c1.5312 0 3-1.3477 2.9297-2.9297-0.097656-1.5977-1.3203-2.9453-2.9609-2.9453z"/>
          </g>
        </svg>
        Request Open Peer Review
      </button>
    </div>
    {% endif %}

    <!-- If reviewer submitted the review (contributor´s turn to add feedback) -->
    {% if opr.contributor.id == user.id and opr.opr_current_reviewer == "contributor"%}
    <div class="table-sidebar__section">
      <button type="button" class="table-sidebar__btn-review table-sidebar__btn-review--start" id="opr-button-contributor-continue" data-url="{% url 'dataedit:peer_review_contributor' table=table schema=schema review_id=opr.opr_id %}">
        <svg height="16" width="16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
          <path d="m13.68 4.8867c-7.5234 0-13.68 6.1562-13.68 13.676v44.527c0 7.5195 6.1562 13.676 13.68 13.676h4.6797v15.223c0 1.2617 0.76172 2.4023 1.9258 2.8867 1.1641 0.48438 2.5078 0.21875 3.4023-0.66797l17.461-17.438h45.195c7.5195 0 13.652-6.1562 13.652-13.68l0.003906-44.527c0-7.5195-6.1328-13.68-13.652-13.68zm0 6.25h72.668c4.1641 0 7.4023 3.2617 7.4023 7.4297v44.523c0 4.1641-3.2383 7.4297-7.4023 7.4297h-46.484v-0.003906c-0.82812-0.003906-1.625 0.31641-2.2188 0.89844l-13.035 13.039v-10.824c-0.007813-1.7148-1.3984-3.1055-3.1133-3.1133h-7.8203c-4.1641 0-7.4297-3.2617-7.4297-7.4297l0.003906-44.523c0-4.1641 3.2617-7.4297 7.4297-7.4297zm36.285 9.4102c-1.2617 0.019531-2.3906 0.79297-2.8594 1.9648l-4.0391 10.055-10.816 0.73828c-1.2734 0.082031-2.3711 0.93359-2.7656 2.1484-0.39844 1.2148-0.015625 2.5508 0.96484 3.3672l8.3242 6.9414-2.6562 10.523h0.003906c-0.32031 1.2422 0.15234 2.5586 1.1914 3.3086 1.043 0.75391 2.4375 0.79688 3.5195 0.10156l9.1797-5.7695 9.1797 5.7695c1.082 0.67188 2.4609 0.62109 3.4922-0.12891 1.0273-0.75 1.4961-2.0469 1.1914-3.2812l-2.6328-10.523 8.3086-6.9414c0.97656-0.81641 1.3633-2.1445 0.97266-3.3555-0.39063-1.2148-1.4805-2.0703-2.75-2.1602l-10.82-0.73828-4.0352-10.055c-0.48047-1.2031-1.6562-1.9844-2.9531-1.9648zm0.046875 11.512 1.8672 4.6641c0.44922 1.1016 1.4883 1.8516 2.6758 1.9336l5.0547 0.34766-3.875 3.2305h-0.003906c-0.92578 0.76562-1.3281 1.9961-1.0391 3.1602l1.2188 4.8633-4.2422-2.6719h0.003906c-1.0156-0.63672-2.3047-0.63672-3.3203 0l-4.2734 2.6719 1.2266-4.8633c0.29687-1.1602-0.10156-2.3906-1.0195-3.1602l-3.875-3.2305 5.0312-0.34766c1.1953-0.070312 2.2461-0.82422 2.7031-1.9336z"/>
        </svg>
        Continue Open Peer Review
      </button>
    </div>
    {% endif %}

    <!-- If reviewer hasn't finished the review -->
    {% if opr.reviewer.id == user.id and opr.opr_current_reviewer == "reviewer"%}
    <div class="table-sidebar__section">
      <button type="button" class="table-sidebar__btn-review table-sidebar__btn-review--start" id="opr-button-reviewer-continue" data-url="{% url 'dataedit:peer_review_reviewer' table=table schema=schema review_id=opr.opr_id %}">
        <svg height="16" width="16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
          <path d="m13.68 4.8867c-7.5234 0-13.68 6.1562-13.68 13.676v44.527c0 7.5195 6.1562 13.676 13.68 13.676h4.6797v15.223c0 1.2617 0.76172 2.4023 1.9258 2.8867 1.1641 0.48438 2.5078 0.21875 3.4023-0.66797l17.461-17.438h45.195c7.5195 0 13.652-6.1562 13.652-13.68l0.003906-44.527c0-7.5195-6.1328-13.68-13.652-13.68zm0 6.25h72.668c4.1641 0 7.4023 3.2617 7.4023 7.4297v44.523c0 4.1641-3.2383 7.4297-7.4023 7.4297h-46.484v-0.003906c-0.82812-0.003906-1.625 0.31641-2.2188 0.89844l-13.035 13.039v-10.824c-0.007813-1.7148-1.3984-3.1055-3.1133-3.1133h-7.8203c-4.1641 0-7.4297-3.2617-7.4297-7.4297l0.003906-44.523c0-4.1641 3.2617-7.4297 7.4297-7.4297zm36.285 9.4102c-1.2617 0.019531-2.3906 0.79297-2.8594 1.9648l-4.0391 10.055-10.816 0.73828c-1.2734 0.082031-2.3711 0.93359-2.7656 2.1484-0.39844 1.2148-0.015625 2.5508 0.96484 3.3672l8.3242 6.9414-2.6562 10.523h0.003906c-0.32031 1.2422 0.15234 2.5586 1.1914 3.3086 1.043 0.75391 2.4375 0.79688 3.5195 0.10156l9.1797-5.7695 9.1797 5.7695c1.082 0.67188 2.4609 0.62109 3.4922-0.12891 1.0273-0.75 1.4961-2.0469 1.1914-3.2812l-2.6328-10.523 8.3086-6.9414c0.97656-0.81641 1.3633-2.1445 0.97266-3.3555-0.39063-1.2148-1.4805-2.0703-2.75-2.1602l-10.82-0.73828-4.0352-10.055c-0.48047-1.2031-1.6562-1.9844-2.9531-1.9648zm0.046875 11.512 1.8672 4.6641c0.44922 1.1016 1.4883 1.8516 2.6758 1.9336l5.0547 0.34766-3.875 3.2305h-0.003906c-0.92578 0.76562-1.3281 1.9961-1.0391 3.1602l1.2188 4.8633-4.2422-2.6719h0.003906c-1.0156-0.63672-2.3047-0.63672-3.3203 0l-4.2734 2.6719 1.2266-4.8633c0.29687-1.1602-0.10156-2.3906-1.0195-3.1602l-3.875-3.2305 5.0312-0.34766c1.1953-0.070312 2.2461-0.82422 2.7031-1.9336z"/>
        </svg>
        Continue Open Peer Review
      </button>
    </div>
    {% endif %}
    {% endif %}
  </div>
</div>
{% endblock %}

{% block main-right-sidebar-content-additional %}

<div class="table-sidebar">


  <div class="table-sidebar__section">
    <h2 class="table-sidebar__heading">Tags</h2>

    {% load dataedit.taghandler %}
    {% get_tags table=table schema=schema as table_tags %}
    {% include 'dataedit/taggable_setting.html' with table=table schema=schema selected=table_tags %}
  </div>

  {% if schema == "scenario" %}
  <div class="table-sidebar__section">
    <div id="filteredScenariosContainer" hx-get="{% url 'factsheet:filter_bundles_view' %}?table_iri=/dataedit/view/{{schema}}/{{table}}" hx-target="#filteredScenariosContainer" hx-swap="outerHTML" hx-trigger="load">
      Loading ...
    </div>
  </div>
  {% endif %}

  

  <div class="table-sidebar__section">
    <h2 class="table-sidebar__heading">Downloads</h2>
    <a href="/api/v0/schema/{{ schema }}/tables/{{ table }}/rows?form=csv" type="button" class="table-sidebar__btn">
      <svg width="14" height="14" version="1.1" fill="currentColor" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/>
      </svg>
      CSV
    </a>
    <a href="/api/v0/schema/{{ schema }}/tables/{{ table }}/rows?form=datapackage" type="button" class="table-sidebar__btn">
      <svg width="14" height="14" version="1.1" fill="currentColor" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/>
      </svg>
      Datapackage
    </a>
  </div>

  {% if schema == "model_draft" %}
  <div class="table-sidebar__section">
    <h2 class="table-sidebar__heading">Uploads</h2>
    <span class="mb-2" {% if not can_add %} data-bs-toggle="tooltip"
    title="You need write permissions on this table to upload data" {% endif %}>
      <a class="table-sidebar__btn {% if not can_add %} disabled {% endif %}" href="{% url 'dataedit:wizard_upload' schema=schema table=table %}">
        <svg width="14" height="14" version="1.1" fill="currentColor" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
          <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
          <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
        </svg>
        CSV (Wizard)
      </a>
    </span>
  </div>
  {% endif %}

  <div class="table-sidebar__section">
    <h2 class="table-sidebar__heading">API Usage</h2>
    <a class="table-sidebar__btn" id="collapseApiBtn" data-bs-toggle="collapse" href="#collapseApi" role="button" aria-expanded="false" aria-controls="collapseApi">
      <span id="collapseApiBtnIcon">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
          <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/>
          <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"/>
        </svg>
      </span>
      View
    </a>
    <button type="button" id="copyApiBtn" class="table-sidebar__btn">
      <span id="copyApiBtnIcon">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
          <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
          <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
        </svg>
      </span>
      Copy
    </button>
    <div class="collapse table-sidebar__collapse" id="collapseApi">
      <div>
        <!-- Formatting below must stay for display purposes -->
        <textarea class="form-control" id="apiContent" rows="6" cols="50">
from requests import get

result = get('https://{{ host }}/api/v0/schema/{{ schema }}/tables/{{ table }}/rows')
for row in result.json():
  # Process the row
        </textarea>
      </div>
    </div>
  </div>

  <div class="table-sidebar__section">
    <a href="{{ table }}/permissions" type="button" class="table-sidebar__btn-info">
      <svg width="14" height="14" version="1.1" fill="currentColor" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <g>
          <path d="m84.699 21.5c-24.301-2.5-31.301-16.5-31.598-17.102-0.60156-1.1992-1.6992-1.8984-3-1.8984-1.3008 0-2.5 0.80078-3 1.8984-0.40234 0.60156-7.5 14.602-31.801 17.102-1.6992 0.19922-3 1.6016-3 3.3984v24.5c0 28.801 34.699 47 36.199 47.801 0.5 0.19922 1 0.39844 1.5 0.39844s1.1016-0.10156 1.5-0.39844c1.5-0.80078 36.199-18.898 36.199-47.801v-24.598c0.10156-1.6992-1.3008-3.1016-3-3.3008zm-3.6992 27.898c0 21.5-24.5 37.102-31 40.898-6.5-3.7969-31-19.297-31-40.898v-21.598c17.5-2.5 26.699-10.699 31-15.898 4.3008 5.1992 13.5 13.398 31 15.898z"/>
          <path d="m37 38.898c0 6 4.1016 11 9.6016 12.5v24.102c0 1.8984 1.5 3.3984 3.3984 3.3984s3.3984-1.5 3.3984-3.3984v-3.8008h4.1992c1.8984 0 3.3984-1.5 3.3984-3.3984 0-1.8984-1.5-3.3984-3.3984-3.3984h-4.1992v-13.504c5.5-1.5 9.6016-6.5 9.6016-12.5 0-7.1992-5.8008-13-13-13-7.1992 0.10156-13 5.9023-13 13zm19.199 0c0 3.3984-2.8008 6.1992-6.1992 6.1992s-6.1992-2.8008-6.1992-6.1992c0-3.3984 2.8008-6.1992 6.1992-6.1992s6.1992 2.8008 6.1992 6.1992z"/>
        </g>
      </svg>
      Permissions
    </a>
    {% if can_add %}
    {% if schema == "model_draft" %}
    <button class="table-sidebar__btn-danger {% if not can_add %} disabled {% endif %}" id="dataview-table-delete">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
      </svg>
      Delete table
    </button>
    {% else %}
      <!-- TODO: Add unpublish button here. Tables that are in another topic than model_draft cant be deleted right away they must be moved back to model_draft. -->
    {% endif %}
    <div id="dataview-table-create-msg" class="invisible dataview-status">
      <span class="spinner spinner-border spinner-border-sm"></span>
      <span class="message"></span>
    </div>
    {% endif %}
    </div>
  </div>

{% endblock main-right-sidebar-content-additional %}

{% block after-head %}

<link href="{% static 'dataedit/dataedit.css' %}" rel="stylesheet" >
<link href="{% static 'dataedit/metadata.css' %}" rel="stylesheet">
<link href="{% static 'dataedit/query-builder.default.min.css' %}" rel="stylesheet">
<link href="{% static 'dataedit/leaflet.css' %}" rel="stylesheet"><!-- src: https://unpkg.com/leaflet@1.3.1/dist/leaflet.css -->
<link href="{% static 'dataedit/jquery.dataTables.min.css' %}" rel="stylesheet"><!-- src: https://cdn.datatables.net/1.10.20/css/jimages/query.dataTables.min.css -->

{% endblock after-head %}

{% block after-body-bottom-js %}

<!-- dialog: keep outside of main container -->
<div id="dataview-confirm-delete" class="modal fade">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              Do you want to delete the table (including data and metadata)?
          </div>
          <div class="modal-body">
              <button class="btn btn-sm btn-dark mr-2" id="dataview-confirm-delete-delete">delete</button>
              <button class="btn btn-sm btn-light" id="dataview-confirm-delete-cancel">cancel</button>
          </div>
      </div>
  </di>
</div>

{% compress js %}
<script src="{% static 'dataedit/jquery.dataTables.min.js' %}"></script><!-- src: https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js -->
<script src="{% static 'dataedit/wkx.min.js' %}"></script>
<script src="{% static 'dataedit/proj4.min.js' %}"></script><!-- src: https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js -->
<script src="{% static 'dataedit/query-builder.standalone.js' %}"></script>
<script src="{% static 'dataedit/backend.js' %}"></script>
<script src="{% static 'dataedit/dataedit.js' %}"></script>
<script src="{% static 'dataedit/plotly-latest.min.js' %}"></script><!-- src: https://unpkg.com/json5@^2.0.0/dist/index.min.js -->
<script src="{% static 'dataedit/json5.min.js' %}"></script><!-- src: https://unpkg.com/json5@^2.0.0/dist/index.min.js -->
<script src="{% static 'modelview/htmx.min.js' %}"></script>

<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="{% static 'dataedit/leaflet.min.js' %}"></script><!-- src: https://unpkg.com/leaflet@1.3.1/dist/leaflet.js -->
{% endcompress %}

<script>
  var csrftoken = getCookie('csrftoken');
  var table = '{{table}}';
  var schema = '{{schema}}';
  var view = {
    type: "{{ current_view.type }}",
    options: JSON5.parse("{{ current_view.options | escapejs }}")
  };
  load_view(schema, table, csrftoken, view);

  var downloadMetadata = function () {
    var metaUrl = "/api/v0/schema/{{ schema }}/tables/{{ table }}/meta";
    $.get(metaUrl).then(function (json) {
      console.log(json);
      // create data url
      var json = JSON.stringify(json, null, 1);
      console.log(json);
      blob = new Blob([json], { type: "application/json" }),
        dataUrl = URL.createObjectURL(blob);
      // create link
      var a = document.createElement("a");
      document.body.appendChild(a);
      // assign url and click
      a.style = "display: none";
      a.href = dataUrl;
      a.download = '{{ table }}.metadata.json';
      a.click();
      // cleanup
      URL.revokeObjectURL(dataUrl);
      a.parentNode.removeChild(a);
    })
  };

  DataEdit(table=table, schema=schema);

  $(function () {
    $('[data-toggle="tooltip"]').tooltip()
  })

  // Copy API to clipboard and toggle "copy" API icon on click
  const copyApiBtn = document.getElementById('copyApiBtn');
  const copyApiBtnIcon = document.getElementById('copyApiBtnIcon');

  copyApiBtn.addEventListener('click', function() {
    var contentToCopy = document.getElementById('apiContent').value;
    if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(contentToCopy).then(() => {
        copyApiBtnIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
              <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/>
          </svg>`;
        setTimeout(() => {
          copyApiBtnIcon.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
            </svg>`;
        }, 3000);
      }).catch(err => {
        console.error('Failed to copy content to clipboard', err);
      });
    } else {
      console.error('Failed to copy content to clipboard');
    }
  });

  // Toggle "view" API icon on content collapse
  const collapseApi = document.getElementById('collapseApi');
  const collapseApiBtnIcon = document.getElementById('collapseApiBtnIcon');

  collapseApi.addEventListener('show.bs.collapse', function () {
    collapseApiBtnIcon.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
        <path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7 7 0 0 0-2.79.588l.77.771A6 6 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755q-.247.248-.517.486z"/>
        <path d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829"/>
        <path d="M3.35 5.47q-.27.24-.518.487A13 13 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7 7 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12z"/>
      </svg>
    `;
  });

  collapseApi.addEventListener('hide.bs.collapse', function () {
    collapseApiBtnIcon.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
        <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/>
        <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"/>
      </svg>
    `;
  });

  document.addEventListener('DOMContentLoaded', function() {
    var button = document.getElementById('opr-button-start');
    if (button) {
      button.addEventListener('click', function() {
          var url = this.getAttribute('data-url');
          window.location.href = url;
      });
    }
  });
  document.addEventListener('DOMContentLoaded', function() {
    var button = document.getElementById('opr-button-request');
    if (button) {
      button.addEventListener('click', function() {
          var url = this.getAttribute('data-url');
          window.location.href = url;
      });
    }
  });
  document.addEventListener('DOMContentLoaded', function() {
    var button = document.getElementById('opr-button-reviewer-continue');
    if (button) {
      button.addEventListener('click', function() {
          var url = this.getAttribute('data-url');
          window.location.href = url;
      });
    }
  });
  document.addEventListener('DOMContentLoaded', function() {
    var button = document.getElementById('opr-button-contributor-continue');
    if (button) {
      button.addEventListener('click', function() {
          var url = this.getAttribute('data-url');
          window.location.href = url;
      });
    }
  });
</script>
{% endblock after-body-bottom-js %}
