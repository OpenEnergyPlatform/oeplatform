{% extends "dataedit/base.html" %}

{% block data_content %}

{% load staticfiles %}
{% load bootstrap3 %}
<h3>{{schema}}.{{table}}</h3> >> <a href="{{table}}/comments"> comments </a>

{% include 'dataedit/taggable_setting.html' with table=table schema=schema selected=tags %}
<hr>

<link rel="stylesheet" href="{% static 'dataedit/dataedit.css' %}">
<script type="text/javascript" src="{% static 'dataedit/views.js' %}"></script>

<!-- vendor css -->
<link href="{% static 'dataedit/recline/vendor/leaflet/0.7.3/leaflet.css' %}" rel="stylesheet">
<link href="{% static 'dataedit/recline/vendor/leaflet.markercluster/MarkerCluster.css' %}" rel="stylesheet">
<link href="{% static 'dataedit/recline/vendor/leaflet.markercluster/MarkerCluster.Default.css' %}" rel=
  "stylesheet">
<link rel="stylesheet" href="{% static 'dataedit/recline/vendor/slickgrid/2.2/slick.grid.css' %}">

<!-- recline css -->
<link href="{% static 'dataedit/recline/css/map.css' %}" rel="stylesheet">

<link href="{% static 'dataedit/recline/css/multiview.css' %}" rel="stylesheet">
<link href="{% static 'dataedit/recline/css/slickgrid.css' %}"rel="stylesheet">
<link href="{% static 'dataedit/recline/css/flot.css' %}" rel="stylesheet">
<link href="https://raw.githubusercontent.com/tobiasahlin/SpinKit/master/css/spinkit.css" rel="stylesheet">
<!-- Vendor JS - general dependencies -->
<script src="{% static 'dataedit/recline/vendor/jquery/1.7.1/jquery.js' %}" type="text/javascript"></script>
<script src="{% static 'dataedit/recline/vendor/underscore/1.4.4/underscore.js' %}" type="text/javascript"></script>
<script src="{% static 'dataedit/recline/vendor/backbone/1.0.0/backbone.js' %}" type="text/javascript"></script>
<script src="{% static 'dataedit/recline/vendor/mustache/0.5.0-dev/mustache.js' %}" type="text/javascript"></script>
<script src="{% static 'dataedit/recline/vendor/bootstrap/3.2.0/js/bootstrap.js' %}" type="text/javascript"></script>

<!-- Vendor JS - view dependencies -->
<script src="{% static 'dataedit/recline/vendor/leaflet/0.7.3/leaflet.js' %}" type="text/javascript"></script>
<script src="{% static 'dataedit/recline/vendor/leaflet.markercluster/leaflet.markercluster.js' %}" type="text/javascript"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/flot/jquery.flot.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/flot/jquery.flot.time.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/moment/2.0.0/moment.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/jquery-ui-1.8.16.custom.min.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/jquery.event.drag-2.2.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/slick.core.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/slick.formatters.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/slick.editors.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/slick.grid.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/plugins/slick.rowselectionmodel.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/plugins/slick.rowmovemanager.js' %}"></script>
<!-- Recline JS (combined distribution, all views) -->
<script type="text/javascript" src="{% static 'dataedit/recline/dist/recline.js' %}"></script>

<script>
    unchecked = false;
    function swap_checked(){
        unchecked = !unchecked;
        build_views();
    }
</script>

<script type="text/javascript" src="{% static 'dataedit/editors.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/backend.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/dumps.js' %}"></script>

<script type="text/javascript">

</script>

<div class="container">
  <style type="text/css">
    .recline-slickgrid {
      min-height: 700px;
    }

    .changelog {
      display: none;
      border-bottom: 1px solid #ccc;
      margin-bottom: 10px;
    }
  </style>

    <label class="btn btn-danger" for="unchecked_box"> <input type="checkbox" id="unchecked_box" onclick="swap_checked()"> Show unchecked rows</label>
    <div class="panel-group">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    Data
                </h4>
            </div>
            <div>
                <div class="data-explorer-here"></div>
            </div>
        </div>
        <hr>
        <div id="unchecked_data_div" class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    Data (unchecked)
 button         </h4>
            </div>
            <div>
                <div class="data-unchecked-explorer-here"></div>
            </div>

        </div>
    </div>


    <div class="well">
        <span class="lead">Commit your changes</span><br>
        Your changes will not be written to the actual OpenEnergyDatabase but an
        additional schema. <br>
        New or changed data has to pass a validation process before it
        is publicated in the next revision. <br>
        <div class="form-group" style="margin:10px">
            <label for="commit-message">Commit message</label>
            <input class="form-control" type="textarea" name="comment" id="commit-message">
            <button class="btn btn-success" id="savebutton"> Save </button>
        </div>
    </div>

  <div style="clear: both;"></div>
    Data is displayed using <a href="http://okfnlabs.org/recline/">recline.js</a>
</div>

<script type="text/javascript">

var data_record = {}
var unchecked_record = {}
var comment_record = {}

function build_views(){
    var dataset_main = new recline.Model.Dataset({
            table: '{{table}}',
            schema: '{{schema}}',
            backend: 'OEP',
            has_row_comments: {% if has_row_comments %} true {% else %} false {% endif %}
    });


    dataset_main.fetch().done(function(dataset) {

        plot_view(dataset,
            true,
            $('.data-explorer-here'), data_record)
    });

    if(unchecked){

        $("#unchecked_data_div").css("display", "block");
        var dataset_unchecked = new recline.Model.Dataset({
                table: '_{{table}}_edit',
                schema: '_{{schema}}',
                backend: 'OEP',
                has_row_comments: false
        });

        dataset_unchecked.fetch().done(function(dataset) {
            plot_view(dataset,
                false,
                $('.data-unchecked-explorer-here'), unchecked_record)
        });
    }
    else
        $("#unchecked_data_div").css("display", "none");


    $('#savebutton').bind('click',
    function() {
        debugger;
        changes = {
            creates: dataset_main._changes.creates,
            updates:    dataset_main.records.filter(
                function(el){return !(jQuery.isEmptyObject(el.changed));}),
            deletes: dataset_main._changes.deletes
        };

        dataset_main.backend.save(changes, dataset_main);
    });
}

build_views(false);



</script>

<button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#csv-upload">Upload CSV</button>
<div id="csv-upload" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Upload a csv-file</h4>
      </div>
      <div class="modal-body">
        <form action="" method="post" enctype="multipart/form-data">{% csrf_token %}
                <div class="input-group">
                <label class="input-group-btn">
                    <span class="btn btn-primary">
                        Browse&hellip; <input type="file" name="csv_file" style="display: none;">
                    </span>
                </label>
                <input type="text" class="form-control" readonly>
            </div>
            <input class="btn btn-success" type="submit" value="Upload" />
</form>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>

<div>
    <table class="table table-hover" style="width:460px">
        <tr>
            <th>Name</th>
            <td>{{comment_on_table.Name}}</td>
        </tr>
        {% if comment_on_table.Source %}
        <tr>
            <th>Sources</th>
            <ul>
            {% for source in comment_on_table.Source %}
                <li> <a href="{{source.URL}}">{{source.Name }}</a></li>
            {% endfor %}
            </ul>
        </tr>
        {% endif %}
        {% if comment_on_table.Reference_date %}
        <tr>
            <th>Reference date</th>
            <td>
            {% for ref in comment_on_table.Reference_date %}
                {{ref}}{% if not forloop.last %}, {% endif %}
            {% endfor %}</td>
        </tr>
        {% endif %}
        {% if comment_on_table.Date_of_collection %}

        <tr>
            <th>Date of Collection</th>
            <td>
            {% for ref in comment_on_table.Date_of_collection %}
                {{ref}}{% if not forloop.last %}, {% endif %}
            {% endfor %}</td>
        </tr>
        {% endif %}
        {% if comment_on_table.Spatial_resolution %}
        <tr>
            <th>Spatial resolution</th>
            <td>
            {% for ref in comment_on_table.Spatial_resolution %}
                {{ref}}{% if not forloop.last %}, {% endif %}
            {% endfor %}</td>
        </tr>
        {% endif %}
        {% if comment_on_table.Description %}
        <tr>
            <th>Description</th>
            <td>
                <ul>
            {% for ref in comment_on_table.Description %}
               <li> {{ref}}</li>
            {% endfor %}</ul></td>
        </tr>
        {% endif %}
        {% if comment_on_table.Licence %}
        <tr>
            <th>Licence</th>
            <ul>
            {% for source in comment_on_table.Licence %}
                <li> <a href="{{source.URL}}">{{source.Name }}</a></li>
            {% endfor %}
            </ul>
        </tr>
        {% endif %}
    </table>


</div>
<hr>
<h3> Revisions </h3>
<div class="well">
    You can download older revisions of the data stored in the platform.
    Each revision has a unique id which can be used for citations. In order to
    save memory not all revisions are available. You can request a dump of the
    current table by clicking the <kbd>Request</kbd> button. Once your data is
    available this button will change into a <kbd>Download</kbd> button. <br>
    Each dump will be deleted if 3 days have passed since the last access and
    you have to request it again.
</div>
    <div id="downloadables">
        <div id="revisions" style="width:460px">
            <table class="table table-hover">
                <tr>
                    <th> Revision </th>
                    <th> Created </th>
                    <th> Last Access </th>
                    <th> Available </th>
                </tr>
                {% for entry, av in revisions %}

                <tr>
                    <td> {{ entry.revision }} </td>
                     <td>
                    {% if av %}
                        {{ av.created }}
                    {% else %}
                        -
                    {% endif %}
                    </td>
                    <td>
                    {% if av %}
                        {{ av.last_accessed }}
                    {% else %}
                        -
                    {% endif %}
                    </td>
                    <td>
                        <div id="revision_request">
                            {% if av %}
                                <a class="btn btn-success" href="{{table}}/{{entry.revision}}/download" >Download</a>
                            {% else %}
                                <btn class="btn btn-default" onclick="request_dump('{{schema}}', '{{table}}', {{entry.revision}});" >Request</btn>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>



{% endblock %}
