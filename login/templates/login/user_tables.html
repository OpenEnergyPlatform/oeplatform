{% extends "base/base-profile.html" %}
{% load django_bootstrap5 %}
{% load static %}
{% load compress %}
{% block main-content-body %}
{% if profile_user == request.user %}
{% include "login/user_nav.html" %}

<!-- ###### Published ###### -->

<section class="profile-category">
    <h2 class="profile-category__heading">Published tables</h2>
    <span class="current">
        Page {{ published_tables_page.number }} of {{ published_tables_page.paginator.num_pages }}.
    </span>
    <div class="profile-tables">
        <div class="profile-tables__row">
            {% for table in published_tables_page %}
            <div class="profile-tables__col">
                <div class="profile-table-card">
                    <div class="profile-table-card__content">
                        <div class="profile-table-card__content--left">
                            <!-- Add as soon as the open peer review is finalized -->
                            {% comment %}
                            {% if table.is_reviewed %}
                            <div class="profile-table-card__tag profile-table-card__tag--success" data-bs-toggle="tooltip" data-bs-placement="top" title="The table has been successfully reviewed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16">
                                    <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/>
                                </svg>
                                Reviewed
                            </div>
                            <div class="profile-table-card__badge">
                                <img style="width:112px;height: 23px;" src="/static/img/badges/badge_iron.png">
                                <!-- <img style="width:112px;height: 23px;" src="/static/img/badges/badge_bronze.png"> -->
                                <!-- <img style="width:112px;height: 23px;" src="/static/img/badges/badge_platinum.png"> -->
                            </div>
                            {% else %}
                            <div class="profile-table-card__tag profile-table-card__tag--warning" data-bs-toggle="tooltip" data-bs-placement="top" title="The table hasn't been reviewed yet">
                                Not reviewed
                            </div>
                            {% endif %}
                            {% endcomment %}
                            <div class="profile-table-card__link">
                                <a href="/dataedit/view/{{ table.schema }}/{{ table.name }}">{{ table.name }}</a>
                            </div>
                        </div>
                        <div class="profile-table-card__content--right">
                            {% if table.license_status.status %}
                            <div class="profile-table-card__tag profile-table-card__tag--info" data-bs-toggle="tooltip" data-bs-placement="top" title="Open License check successful">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16">
                                    <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/>
                                </svg>
                                License
                            </div>
                            {% else %}
                            <div class="profile-table-card__tag profile-table-card__tag--danger" data-bs-toggle="tooltip" data-bs-placement="top" title="Open License check failed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
                                </svg>
                                License check failed
                            </div>
                            {% endif %}

                            <div class="profile-table-card__tag">
                                <svg width="12" height="12" version="1.1" fill="currentColor" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                                    <path d="m8.5,11.97c3.07-.26,5.5-2.83,5.5-5.97,0-3.31-2.69-6-6-6S2,2.69,2,6s2.43,5.72,5.5,5.97v3.03H3.5v1h9v-1h-4v-3.03ZM3,6c0-2.76,2.24-5,5-5s5,2.24,5,5-2.24,5-5,5-5-2.24-5-5Z"></path>
                                </svg>
                                {{ table.schema }}
                            </div>
                        </div>

                        <!-- Add once embargo branch is merged PR https://github.com/OpenEnergyPlatform/oeplatform/pull/1534 -->
                        <!-- <div class="profile-table-card__content-secondary">
                            <span class="profile-table-card__embargo">
                                Embargo until 06/05/2024
                                <button type="button" class="btn btn-outline-light" data-bs-toggle="tooltip" data-bs-placement="top" title="Test text">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="#294456" class="bi bi-info-circle" viewBox="0 0 16 16">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
                                    </svg>
                                </button>
                            </span>
                        </div> -->
                    </div>
                    {% if table.license_status.error %}
                    <div class="profile-table-card__content-danger">
                        <div class="profile-table-card__content-danger-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-exclamation-circle" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
                            </svg>
                        </div>
                        <div class="profile-table-card__content-danger-message">
                            Potential publishing without an open license.
                        </div>
                        <div class="profile-table-card__content-danger-details">
                            <p>
                                <button type="button" data-bs-toggle="collapse" data-bs-target="#collapseWarningDetails{{ table.name }}" aria-expanded="false" aria-controls="collapseWarningDetails{{ table.name }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-caret-right-fill" viewBox="0 0 16 16">
                                        <path d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"/>
                                    </svg>
                                    Details
                                </button>
                            </p>
                            <div class="collapse" id="collapseWarningDetails{{ table.name }}">
                                License check failed because of: {{ table.license_status.error }} <br><br>
                                <a href={{EXTERNAL_URLS.spdx_licenses}} class="card-link">Please use a SPDX license identifier.</a> <br><br>
                                Please revisit your metadata and check the license information. Do not publish data that does not hold an open license.
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <nav aria-label="Page navigation profile tables" class="pagination-nav">
        <ul>
            {% if published_tables_page.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?published_page={{ published_tables_page.previous_page_number }}" tabindex="-1" aria-disabled="true">&laquo;Previous</a>
                <a href="?published_page=1">1</a>
            </li>
            {% endif %}

            <li class="page-item active">
                <a class="page-link" href="?published_page={{ published_tables_page.number }}"> {{ published_tables_page.number  }} </a>
            </li>

            {% if published_tables_page.has_next %}
            <li class="page-item">
                <a class="page-link" href="?published_page={{published_tables_page.next_page_number}}">Next</a>
            </li>
            {% endif %}
        </ul>

    </nav>

</section>

<!-- ###### Draft Tables ###### -->
<section class="profile-category">
    <h2 class="profile-category__heading">Draft tables</h2>
    <span class="current">
        Page {{ draft_tables_page.number }} of {{ draft_tables_page.paginator.num_pages }}.
    </span>
    <div class="profile-tables">
        <div class="profile-tables__row">
            {% for table in draft_tables_page %}
            <div class="profile-tables__col">
                <div class="profile-table-card">
                    <div class="profile-table-card__content">
                        <div class="profile-table-card__content--left">
                            <!-- Add as soon as the open peer review is finalized -->
                            {% comment %}
                            {% if table.is_reviewed %}
                            <div class="profile-table-card__tag profile-table-card__tag--success" data-bs-toggle="tooltip" data-bs-placement="top" title="The table has been successfully reviewed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16">
                                    <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/>
                                </svg>
                                Reviewed
                            </div>
                            <div class="profile-table-card__badge">
                                <div id="badge-container" hx-get="{% url 'metadata-review-badge-icon' request.user.id table.name %}" hx-trigger="load" hx-swap="outerHTML">
                                </div>
                                <!-- <img style="width:112px;height: 23px;" src="/static/img/badges/badge_bronze.png"> -->
                                <!-- <img style="width:112px;height: 23px;" src="/static/img/badges/badge_platinum.png"> -->
                            </div>
                            {% else %}
                            <div class="profile-table-card__tag profile-table-card__tag--warning" data-bs-toggle="tooltip" data-bs-placement="top" title="The table hasn't been reviewed yet">
                                Not reviewed
                            </div>
                            {% endif %}
                            {% endcomment %}
                            <div class="profile-table-card__link">
                                <a href="/dataedit/view/{{ table.schema }}/{{ table.name }}">{{ table.name }}</a>
                            </div>
                        </div>
                        <div class="profile-table-card__content--right">
                            {% if table.license_status.status %}
                            <div class="profile-table-card__tag profile-table-card__tag--info" data-bs-toggle="tooltip" data-bs-placement="top" title="Open License check successful">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16">
                                    <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/>
                                </svg>
                                License
                            </div>
                            <button class="profile-table-card__btn profile-table-card__btn--sm publish-button" data-bs-toggle="modal" data-bs-target="#publishModal" data-schema="{{ table.schema }}" data-tableName="{{ table.name }}">Publish</button>

                            {% else %}
                            <div class="profile-table-card__tag profile-table-card__tag--danger" data-bs-toggle="tooltip" data-bs-placement="top" title="Open License check failed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
                                </svg>
                                License check failed
                            </div>
                            <button class="profile-table-card__btn profile-table-card__btn--sm disabled">Publish</button>
                            {% endif %}

                            <div class="profile-table-card__tag">
                                <svg width="12" height="12" version="1.1" fill="currentColor" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                                    <path d="m8.5,11.97c3.07-.26,5.5-2.83,5.5-5.97,0-3.31-2.69-6-6-6S2,2.69,2,6s2.43,5.72,5.5,5.97v3.03H3.5v1h9v-1h-4v-3.03ZM3,6c0-2.76,2.24-5,5-5s5,2.24,5,5-2.24,5-5,5-5-2.24-5-5Z"></path>
                                </svg>
                                {{ table.schema }}
                            </div>
                        </div>


                        <!-- Add once embargo branch is merged PR https://github.com/OpenEnergyPlatform/oeplatform/pull/1534 -->
                        <!-- <div class="profile-table-card__content-secondary">
                        <span class="profile-table-card__embargo">
                                Embargo until 06/05/2024
                                <button type="button" class="btn btn-outline-light" data-bs-toggle="tooltip" data-bs-placement="top" title="Test text">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="#294456" class="bi bi-info-circle" viewBox="0 0 16 16">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
                                    </svg>
                                </button>
                            </span>
                        </div>  -->
                    </div>
                    {% if table.license_status.error %}
                    <div class="profile-table-card__content-danger">
                        <div class="profile-table-card__content-danger-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-exclamation-circle" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
                            </svg>
                        </div>
                        <div class="profile-table-card__content-danger-message">
                            {{ table.license_status.error }}
                        </div>
                        <div class="profile-table-card__content-danger-details">
                            <a href="{{EXTERNAL_URLS.spdx_licenses}}">Please use a SPDX license identifier</a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <nav aria-label="Page navigation profile tables" class="pagination-nav">
        <ul>
            {% if draft_tables_page.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?draft_page={{ draft_tables_page.previous_page_number }}" tabindex="-1" aria-disabled="true">&laquo;Previous</a>
            </li>
            {% endif %}

            <li class="page-item active">
                <a class="page-link" href="?draft_page={{ draft_tables_page.number }}"> {{ draft_tables_page.number  }} </a>
            </li>

            {% if draft_tables_page.has_next %}
            <li class="page-item">
                <a class="page-link" href="?draft_page={{draft_tables_page.next_page_number}}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
</section>
{% endif %}

<div id="schemaWhitelistData" style="display: none;">{{ schema_whitelist|json_script:"schemaWhitelistData" }}</div>


<!-- Modal for publishing functionality (after pressing publish button) -->

<div class="modal fade" id="publishModal" tabindex="-1" aria-labelledby="publishModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="publishModalLabel">Publish Table</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="publish-options">
                    <select class="form-select schema-dropdown"></select>
                    <button class="btn btn-primary confirm-publish" data-bs-dismiss="modal">Confirm</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block main-right-sidebar-content %}
    {% include "login/sidebar_user.html" %}
{% endblock main-right-sidebar-content %}

{% block after-body-bottom-js %}

{% compress js %}
<script src="{% static 'ontology/htmx.js' %}"></script>
{% endcompress %}

<script type="text/javascript">
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function publishTable(schema, tableName, toSchema) {
  return fetch(`/api/v0/schema/${schema}/tables/${tableName}/move/${toSchema}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie("csrftoken"),
      'Content-Type': 'application/json',
      'Accept': 'application/json',
    }
  }).then(response => {
    if (response.ok) {
      alert('Table moved successfully.');
    } else {
      response.text().then(text => { alert(`Error moving table: ${text}`); });
    }
  });
}

document.addEventListener('DOMContentLoaded', function () {
    let schemaWhitelist = [];
    let relatedButton;
    let publishModalInstance; // Declare publishModalInstance in a higher scope

    const schemaDataElement = document.querySelector('#schemaWhitelistData');
    if (schemaDataElement) {
        schemaWhitelist = JSON.parse(schemaDataElement.textContent);
    }

    // Event listener for modal show event
    var publishModal = new bootstrap.Modal(document.getElementById('publishModal'));
    publishModalInstance = bootstrap.Modal.getInstance(publishModal._element);

    publishModalInstance._element.addEventListener('show.bs.modal', function (event) {
        relatedButton = event.relatedTarget;
        const dropdown = this.querySelector('.schema-dropdown');
        dropdown.innerHTML = '';
        schemaWhitelist.forEach(schema => {
            dropdown.innerHTML += `<option value="${schema}">${schema}</option>`;
        });
    });

    // Event listener for Confirm button click inside the modal
    document.querySelector('.confirm-publish').addEventListener('click', function () {
        const dropdown = document.querySelector('.schema-dropdown');
        if (relatedButton) {
            const schema = relatedButton.getAttribute('data-schema');
            const tableName = relatedButton.getAttribute('data-tableName');
            const toSchema = dropdown.value;

            publishTable(schema, tableName, toSchema);
        } else {
            console.error('relatedButton is not defined.');
        }
    });
});
</script>

<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
  </script>

{% endblock after-body-bottom-js %}
