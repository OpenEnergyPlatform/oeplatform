{% extends "modelview/base.html" %}
{% load django_bootstrap5 %}
{% load static %}
{% load modelview_extras %}
{% load dataedit.taghandler %}
{% block after-head %}
<link rel="stylesheet" href="{% static 'css/mv-style.css' %}">
<link href="{% static 'dataedit/jquery.dataTables.min.css' %}" rel="stylesheet"><!-- src: https://cdn.datatables.net/1.10.20/css/jimages/query.dataTables.min.css -->


<style>
</style>
{% endblock %}


{% block site-header %}
    <div class="main-header">
        <h1 class="main-header__title">
            <svg width="20" height="20" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M4.31781 2.68742C3.35608 3.12457 3 3.62628 3 4C3 4.37372 3.35608 4.87543 4.31781 5.31258C5.23441 5.72922 6.53579 6 8 6C9.46421 6 10.7656 5.72922 11.6822 5.31258C12.6439 4.87543 13 4.37372 13 4C13 3.62628 12.6439 3.12457 11.6822 2.68742C10.7656 2.27078 9.46421 2 8 2C6.53579 2 5.23441 2.27078 4.31781 2.68742ZM13 5.69813C12.729 5.90046 12.4201 6.07563 12.096 6.22295C11.022 6.71114 9.57336 7 8 7C6.42664 7 4.97802 6.71114 3.90401 6.22295C3.5799 6.07563 3.27105 5.90046 3 5.69813V7C3 7.37372 3.35608 7.87543 4.31781 8.31258C5.23441 8.72922 6.53579 9 8 9C9.46421 9 10.7656 8.72922 11.6822 8.31258C12.6439 7.87543 13 7.37372 13 7V5.69813ZM14 4C14 2.993 13.1249 2.24472 12.096 1.77705C11.022 1.28886 9.57336 1 8 1C6.42664 1 4.97802 1.28886 3.90401 1.77705C2.87513 2.24472 2 2.993 2 4V13C2 14.007 2.87513 14.7553 3.90401 15.2229C4.97802 15.7111 6.42664 16 8 16C9.57336 16 11.022 15.7111 12.096 15.2229C13.1249 14.7553 14 14.007 14 13V4ZM13 8.69813C12.729 8.90046 12.4201 9.07563 12.096 9.22295C11.022 9.71114 9.57336 10 8 10C6.42664 10 4.97802 9.71114 3.90401 9.22295C3.5799 9.07563 3.27105 8.90046 3 8.69813V10C3 10.3737 3.35608 10.8754 4.31781 11.3126C5.23441 11.7292 6.53579 12 8 12C9.46421 12 10.7656 11.7292 11.6822 11.3126C12.6439 10.8754 13 10.3737 13 10V8.69813ZM13 11.6981C12.729 11.9005 12.4201 12.0756 12.096 12.2229C11.022 12.7111 9.57336 13 8 13C6.42664 13 4.97802 12.7111 3.90401 12.2229C3.5799 12.0756 3.27105 11.9005 3 11.6981V13C3 13.3737 3.35608 13.8754 4.31781 14.3126C5.23441 14.7292 6.53579 15 8 15C9.46421 15 10.7656 14.7292 11.6822 14.3126C12.6439 13.8754 13 13.3737 13 13V11.6981Z" fill="#293B46"/>
            </svg>
            {{ label }} Factsheets
        </h1>
        <div class="main-header__wizard">
            Overview
        </div>
    </div>
{% endblock site-header %}

{% block main-right-sidebar-content %}
  <hr>
  <h3>Actions</h3>
    <a role="button" class="btn btn-success" href="add">
      <span class="fas fa-plus"></span> Add {{ label }}
    </a>
    <a id="dlcsv" role="button"  class="btn btn-info" href="download">
      <span class="fas fa-download"></span> Download CSV
    </a>
  <hr>

  <h3>Tags</h3>
  <div style="display: flex; flex-flow: wrap">
      {% for t in tags %}
          <label class="tag-checkbox-container form-label {% if t.id in tags %} tag-checkbox-checked {% endif %}" style="background:{{ t.color }};color:{% readable_text_color t.color %}">
              <input {% if t.id in tags %} checked="checked" {% endif %} type="checkbox" class="tag-checkbox" name="tags" id="select_{{ t.id }}" value="{{ t.id }}" onchange="apply_tag_filter(event.target)">
              <span>{{ t.name }}</span>
              <span class="tag-checkbox-icon fas fa-check"></span>
          </label>
      {% endfor %}
  </div>
  <hr>

  <h3>Fields</h3>
  <div class="checkbox-container">
  {% for heading,d in fields.items %}
      <div class="checkbox-item">
          <a class="fill-div" data-bs-toggle="collapse" href="#{{heading.split|join:'_'}}">{{heading}}</a>

          <div id="{{heading.split|join:'_'}}" class="collapse">
              {% for key,value in d.items %}
                  <div style="display: flex;flex-flow: nowrap;align-items: center">
                      <input type="checkbox" onchange="apply_filter(event.target)" id="{{key}}" {% if key.split|join:'_' in default %} checked="checked" {%endif %}>
                      <label class="form-label" style="margin: 0" for="{{key}}">{{key}}</label>
                  </div>
              {% endfor %}
          </div>
      </div>
  {% endfor %}
  </div>
  <hr>

{% endblock main-right-sidebar-content %}

{% block factsheets_content %}

{% if label == 'Model' or label == 'Framework' %}
    <div style="width:100%; overflow-y: auto; padding-bottom: 1em">
        <table id="overview" class="display" style="width:100%;">
        </table>
    </div>

{% elif label == 'Scenario' %}

    <div class="list-group">
        {% for id, name in models %}
            <a class="list-group-item" href="{{id}}">{{ name }}</a>
        {% endfor %}
    </div>

{% endif %}




{% endblock %}

{% block after-body-bottom-js %}
    <script src="{% static 'dataedit/jquery.dataTables.min.js' %}"></script><!-- src: https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js -->

    <script>
    var dt;

    var full_data = [
        {% for model in models %}
            {
                {% for d in fields.values %}
                    model_name: '<a href="{{model.id}}">{{model.model_name}}</a>',
                    tags: [ {% for tag in model.tags %} {id:'{{tag.id}}', name:'{{tag.name}}', color:'{{tag.color}}',  textcolor:'{% readable_text_color tag.color %}'}, {%endfor%} ],

                    {% for group in d.values %}
                        {% for field in group %}
                            {{ field }}: {{model|get_model_value:field}},
                        {% endfor %}
                    {% endfor %}

                {% endfor %}
            },
        {% endfor %}
    ]

    var render_tag = function (data, type, row){
        var s = '';
        for(var i in data){
            if(i <= 4) {
                var tag = data[i];
                s += '<a href="" class="btn tag" style="background:' + tag.color + '; color:' + tag.textcolor + '; display:inline-block;">' + tag.name + '</a>'
            }
        }
        return s;
    }

    var all_columns = [
        {data: 'model_name', name: 'Name', title: 'Name', visible: true},
        {% for d in fields.values %}
            {% for l, group in d.items %}
                    {% for field in group %}
                        {data: '{{ field }}', name: '{{ field }}', title: '{{ field|white_out:'_' }}', visible: {% if field in default %} true {% else %} false {%endif %}},
                    {% endfor %}
            {% endfor %}
        {% endfor %}
        {data: 'tags', name: 'tags', title: 'tags', visible: true, render:render_tag },
    ];

    var fields = {
        {% for d in fields.values %}
            {% for l, group in d.items %}
                '{{ l }}' : [
                    {% for field in group %}
                        '{{ field }}',
                    {% endfor %}
                ],
            {% endfor %}
        {% endfor %}
    };

    var active_tags = [];

    var apply_filter = function (sender){
        for (var i in fields[sender.id]) {
            var property = fields[sender.id][i]
            var column = dt.column(property+':name')
            column.visible( sender.checked );
        }


    }




    var apply_tag_filter = function (sender){
        if(sender.checked && active_tags.indexOf(sender.id) <0){
            active_tags.push(sender.id);
        } else {
            var id = active_tags.indexOf(sender.id);
            if(id>=0){
                active_tags.splice(id, 1);
            }
        }
        set_csv_link();
        dt.draw();
    }

    var set_csv_link = function (){
        var href='download?';
        href += 'tags=';
        href += active_tags.join([separator = ',']);
        document.getElementById("dlcsv").setAttribute("href", href);
    }

    $(document).ready( function () {
        dt = $('#overview').DataTable( {data: full_data, columns: all_columns});
        var tags_col = dt.column('tags:name').index();
        $.fn.dataTable.ext.search.push(
        function( settings, data, dataIndex ) {
            for (var required of active_tags) {
                var matches = false;
                var tags = dt.row(dataIndex).data().tags
                if(tags === undefined){
                    return false;
                }
                for (var tag of tags) {
                    if (required === 'select_'+tag.id) {
                        matches=true
                    }
                }
                if(!matches){
                    return false;
                }
            }
            return true;
        }
);

    } );


    </script>

{% endblock %}
